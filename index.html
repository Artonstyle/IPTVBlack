<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Black IPTV 2026 – Samsung Tizen</title>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script type="text/javascript" src="$WEBAPIS/webapis/webapis.js"></script>

  <style>
    :root{
      --blue:#0045ff;
      --cyan:#00d2ff;
      --glass:rgba(0,40,120,.22);
      --glass2:rgba(0,0,0,.26);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.40);
      --danger:#ff4d4d;
      --gold:#ffcc00;
      --ok:#25d366;
    }
    *{box-sizing:border-box; outline:none}
    body{
      width:1920px;height:1080px;margin:0;
      background: radial-gradient(circle at top right, #001a4d, #00050a);
      background-size:cover;background-position:center;
      color:#fff;font-family: Arial, sans-serif; overflow:hidden;
    }

    header{
      height:160px;
      display:flex; justify-content:space-between; align-items:center;
      padding:0 80px;
      border-bottom:2px solid rgba(0,210,255,.15);
    }
    .brand{font-size:52px; font-weight:900; letter-spacing:-1px}
    .brand span{color:var(--cyan); font-style:italic}
    #menu{display:flex; gap:18px}
    .menu-item{
      padding:18px 46px;
      font-size:34px;
      font-weight:900;
      color:rgba(255,255,255,.35);
      border-radius:16px;
      transition:.12s;
    }
    .menu-item.focused{
      background:var(--blue);
      color:#fff;
      box-shadow:0 0 30px rgba(0,69,255,.6);
      transform:scale(1.04);
    }

    main{height:920px; padding:40px 60px}

    .panel{
      height:100%;
      border-radius:32px;
      background: var(--glass);
      border:1px solid rgba(0,210,255,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    #tv-view, #vod-view, #setup-view { height:100%; display:none; }

    /* -----------------------------
       TV VIEW
    ----------------------------- */
    .tv-root{
      height:100%;
      display:flex;
      gap:24px;
      padding:22px;
    }
    .col{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(0,210,255,.14);
      border-radius:26px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .col-h{
      padding:18px 20px;
      color:var(--cyan);
      font-weight:900;
      letter-spacing:3px;
      font-size:14px;
      text-transform:uppercase;
      border-bottom:1px solid rgba(0,210,255,.10);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .list{
      flex:1;
      overflow-y:auto;
      padding:14px;
    }
    .list::-webkit-scrollbar{ width:0; }
    .entry{
      border-radius:16px;
      border:1px solid rgba(0,210,255,.12);
      background: rgba(0,0,0,.24);
      padding:16px 16px;
      margin-bottom:12px;
      transition:.12s;
      color:rgba(255,255,255,.82);
      font-weight:900;
      font-size:26px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .entry .sub{
      color:rgba(255,255,255,.55);
      font-weight:800;
      font-size:18px;
      letter-spacing:.3px;
      margin-left:auto;
    }
    .entry.focused{
      border-color: rgba(0,210,255,.85);
      box-shadow:0 0 18px rgba(0,210,255,.12);
      transform: scale(1.02);
      background: rgba(0,69,255,.18);
      color:#fff;
    }
    .chan-num{
      color:var(--cyan);
      font-weight:900;
      font-size:18px;
      min-width:42px;
      opacity:.85;
    }
    .star{
      margin-left:auto;
      font-size:26px;
      color:transparent;
      -webkit-text-stroke:2px var(--gold);
      text-shadow:0 0 10px rgba(255,204,0,.2);
    }
    .is-fav .star{
      color:var(--gold);
      -webkit-text-stroke:0px transparent;
      text-shadow:0 0 12px rgba(255,204,0,.55);
    }

    .player{
      flex:1.2;
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:14px;
    }
    .video-box{
      background:#000;
      border:2px solid rgba(0,210,255,.22);
      border-radius:26px;
      overflow:hidden;
      height:auto;
      position:relative;
      aspect-ratio:16/9;
      max-height:520px;
    }
    video{width:100%;height:100%;object-fit:contain}
    .pinfo{
      padding:14px 14px 8px 14px;
      display:flex; flex-direction:column; gap:8px;
    }
    .pname{ font-size:44px; font-weight:900; }
    .phint{ color:rgba(255,255,255,.55); font-size:18px; font-weight:800; letter-spacing:.2px; }

    /* Fullscreen TV */
    body.is-fullscreen header{ display:none!important; }
    body.is-fullscreen #tv-left,
    body.is-fullscreen #tv-mid,
    body.is-fullscreen .pinfo{ display:none!important; }

    body.is-fullscreen main{
      padding:0!important;
      margin:0!important;
      height:1080px!important;
      width:1920px!important;
    }
    body.is-fullscreen .video-box{
      position:fixed;
      left:0; top:0;
      width:1920px; height:1080px;
      z-index:9999;
      border:none; border-radius:0;
      max-height:none;
    }
    body.is-fullscreen video{ object-fit:contain; }

    /* -----------------------------
       VOD VIEW
    ----------------------------- */
    .vod-root{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:18px 22px;
    }
    .vod-topbar{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(0,210,255,.14);
      border-radius:22px;
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .vod-title{
      font-size:30px;
      font-weight:900;
      letter-spacing:.4px;
    }
    .vod-sub{
      color:rgba(255,255,255,.62);
      font-size:18px;
      font-weight:800;
    }
    .vod-rows{
      flex:1;
      overflow-y:auto;
      padding-right:6px;
    }
    .vod-rows::-webkit-scrollbar{ width:0; }

    .row{ margin:14px 0 18px 0; }
    .row-h{
      font-size:24px;
      font-weight:900;
      color:var(--cyan);
      letter-spacing:2px;
      margin:0 0 10px 8px;
      text-transform:uppercase;
    }
    .strip{
      position:relative;
      overflow:hidden;
      border-radius:18px;
      padding:10px 10px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(0,210,255,.10);
    }
    .strip-inner{
      display:flex;
      gap:14px;
      transition: transform .15s ease-out;
      will-change: transform;
    }
    .card{
      width:260px;
      height:150px;
      border-radius:16px;
      overflow:hidden;
      position:relative;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(0,210,255,.12);
      flex:0 0 auto;
      transition:.12s;
    }
    .card img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      background:#000;
    }
    .card .cap{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:10px 10px;
      font-size:14px;
      font-weight:900;
      background: linear-gradient(to top, rgba(0,0,0,.92), rgba(0,0,0,0));
      text-shadow:0 2px 10px rgba(0,0,0,.75);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      letter-spacing:.3px;
    }
    .card.focused{
      border-color: rgba(0,210,255,.85);
      box-shadow:0 0 18px rgba(0,210,255,.12);
      transform: scale(1.10);
      z-index:2;
    }

    .vod-player-wrap{
      display:flex;
      gap:18px;
      margin-top:8px;
      align-items:stretch;
    }
    .vod-player{
      flex:1;
      background:#000;
      border:2px solid rgba(0,210,255,.22);
      border-radius:22px;
      overflow:hidden;
      height:320px;
    }
    .vod-info{
      width:520px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(0,210,255,.14);
      border-radius:22px;
      padding:16px;
      overflow:hidden;
    }
    .vod-info h3{
      margin:0;
      color:var(--cyan);
      font-size:14px;
      letter-spacing:3px;
      text-transform:uppercase;
    }
    .vod-info .big{ margin-top:10px; font-weight:900; font-size:28px; }
    .vod-info .small{
      margin-top:10px;
      color:rgba(255,255,255,.6);
      font-size:18px;
      font-weight:800;
      line-height:1.35;
    }

    
    /* -----------------------------
       VOD VIEW (Netflix Grid)
    ----------------------------- */
    .vod-netflix{
      height:100%;
      display:flex;
      gap:24px;
      padding:22px;
    }
    .vod-cat-col{
      width:420px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(0,210,255,.14);
      border-radius:26px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .vod-grid-col{
      flex:1;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(0,210,255,.14);
      border-radius:26px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .vod-grid-scroll{
      flex:1;
      overflow-y:auto;
      padding:16px;
    }
    .vod-grid-scroll::-webkit-scrollbar{ width:0; }

    .vod-grid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:18px;
    }
    .vod-tile{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(0,210,255,.12);
      transition:.12s;
    }
    .vod-tile::before{ content:""; display:block; padding-top:150%; }
    .vod-tile img{
      position:absolute; top:0; left:0; right:0; bottom:0;
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      background:#000;
    }
    .vod-tile .cap{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:12px 12px;
      font-size:18px;
      font-weight:900;
      background: linear-gradient(to top, rgba(0,0,0,.92), rgba(0,0,0,0));
      text-shadow:0 2px 10px rgba(0,0,0,.75);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      letter-spacing:.3px;
    }
    .vod-tile.focused{
      border-color: rgba(0,210,255,.85);
      box-shadow:0 0 18px rgba(0,210,255,.12);
      transform: scale(1.10);
      z-index:2;
    }

/* -----------------------------
       SETUP VIEW (Tabs + Content)
    ----------------------------- */
    #setup-view{
      display:flex;
      flex-direction:column;
      gap:22px;
      padding:22px;
    }

    .tabs{
      display:flex; gap:14px;
      padding:10px;
      border-radius:22px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(0,210,255,.16);
    }
    .tab{
      padding:14px 24px;
      font-size:22px;
      font-weight:900;
      color:rgba(255,255,255,.45);
      border-radius:16px;
      transition:.12s;
      background: rgba(0,0,0,.15);
      border:1px solid rgba(0,210,255,.10);
    }
    .tab.focused{
      color:#fff;
      background: var(--blue);
      border-color: rgba(255,255,255,.15);
      box-shadow:0 0 18px rgba(0,69,255,.35);
      transform:scale(1.02);
    }

    .content-col{
      flex:1;
      background: var(--glass2);
      border:1px solid rgba(0,210,255,.14);
      border-radius:26px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .content-header{
      padding:18px 20px;
      color:var(--cyan);
      font-weight:900;
      letter-spacing:3px;
      font-size:14px;
      text-transform:uppercase;
      border-bottom:1px solid rgba(0,210,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .content-body{
      flex:1;
      overflow-y:auto;
      padding:16px;
    }
    .content-body::-webkit-scrollbar{ width:0; }

    .hint{
      color:rgba(255,255,255,.60);
      font-size:18px;
      line-height:1.35;
      letter-spacing:.2px;
      margin-left:auto;
      font-weight:700;
      text-transform:none;
    }

    .card2{
      border-radius:18px;
      border:1px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.22);
      padding:16px;
      margin-bottom:14px;
      transition:.12s;
      color:rgba(255,255,255,.92);
    }
    .card2.focused{
      border-color: rgba(0,210,255,.70);
      box-shadow:0 0 22px rgba(0,210,255,.12);
      transform: scale(1.01);
      background: rgba(0,69,255,.18);
    }
    .card2-title{ font-weight:900; font-size:30px; }
    .card2-sub{ margin-top:10px; color:rgba(255,255,255,.65); font-size:22px; word-break:break-all; }

    .badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      background: rgba(0,210,255,.12);
      border:1px solid rgba(0,210,255,.22);
      color: rgba(255,255,255,.90);
      font-weight:900;
      font-size:16px;
      margin-left:10px;
      vertical-align:middle;
    }
    .badge.active{ background: rgba(0,69,255,.30); border-color: rgba(0,69,255,.55); }

    .label2{ color:var(--cyan); font-weight:900; letter-spacing:2px; font-size:14px; margin-top:10px; text-transform:uppercase; }

    /* Inputs: readonly (damit Samsung Keyboard NICHT aufgeht) */
    .input{
      width:100%;
      padding:18px 16px;
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(0,210,255,.22);
      background: rgba(0,0,0,.28);
      color:#fff;
      font-size:24px;
    }
    .input.focused{
      border-color: rgba(0,210,255,.80);
      box-shadow:0 0 18px rgba(0,210,255,.12);
      background: rgba(0,69,255,.14);
    }

    .btnrow{ display:flex; gap:12px; margin-top:14px; }
    .btn{
      flex:1;
      padding:16px 14px;
      text-align:center;
      border-radius:14px;
      border:1px solid rgba(0,210,255,.22);
      background: rgba(0,69,255,.20);
      font-weight:900;
      font-size:22px;
      transition:.12s;
      user-select:none;
    }
    .btn.danger{ border-color: rgba(255,77,77,.45); background: rgba(255,77,77,.15); }
    .btn.ok{ border-color: rgba(37,211,102,.45); background: rgba(37,211,102,.12); }
    .btn.focused{
      background: var(--blue);
      box-shadow:0 0 18px rgba(0,69,255,.35);
      transform:scale(1.02);
    }
    .btn.danger.focused{ background: rgba(255,77,77,.35); box-shadow:0 0 18px rgba(255,77,77,.25); }
    .btn.ok.focused{ background: rgba(37,211,102,.28); box-shadow:0 0 18px rgba(37,211,102,.18); }

    .divider{ height:1px; background: rgba(0,210,255,.18); margin:16px 0; }

    /* Background tiles (5 spalten) */
    .tile-wrap{ display:flex; flex-wrap:wrap; gap:14px; }
    .tile{
      flex: 0 0 calc((100% - 14px*4) / 5);
      border-radius:18px;
      border:1px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.28);
      overflow:hidden;
      position:relative;
      transition:.12s;
    }
    .tile::before{ content:""; display:block; padding-top:56.25%; }
    .tile.focused{
      border-color: rgba(0,210,255,.85);
      box-shadow:0 0 18px rgba(0,210,255,.12);
      transform: scale(1.05);
    }
    .tile img{
      position:absolute; top:0; left:0; right:0; bottom:0;
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      background:#000;
    }
    .tile .label{
      position:absolute; left:0; right:0; bottom:0;
      padding:10px 10px;
      font-size:16px;
      font-weight:900;
      background: linear-gradient(to top, rgba(0,0,0,.92), rgba(0,0,0,0));
      text-shadow:0 2px 10px rgba(0,0,0,.75);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      color:#fff;
      letter-spacing:.5px;
    }

    /* -----------------------------
       M3U/Xtream: 2 Spalten Layout
    ----------------------------- */
    .two-col{
      display:flex;
      gap:16px;
      align-items:stretch;
      min-height:100%;
    }
    .left-col{
      width:48%;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(0,210,255,.12);
      border-radius:18px;
      padding:14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .right-col{
      width:52%;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(0,210,255,.12);
      border-radius:18px;
      padding:14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .col-title{
      color:var(--cyan);
      font-weight:900;
      letter-spacing:2px;
      font-size:14px;
      text-transform:uppercase;
      margin:4px 4px 10px 4px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .profiles-scroll{
      flex:1;
      overflow-y:auto;
      padding-right:6px;
    }
    .profiles-scroll::-webkit-scrollbar{ width:0; }

    .prof-row{
      border-radius:16px;
      border:1px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.22);
      padding:14px;
      margin-bottom:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      transition:.12s;
    }
    .prof-row.active{
      border-color: rgba(0,210,255,.55);
      box-shadow:0 0 18px rgba(0,210,255,.10);
    }
    .prof-head{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .prof-name{
      font-weight:900;
      font-size:26px;
      flex:1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .prof-url{
      color:rgba(255,255,255,.65);
      font-weight:800;
      font-size:18px;
      word-break:break-all;
    }
    .prof-actions{
      display:flex;
      gap:10px;
    }

    .focusable{ }

    /* -----------------------------
       Virtual Keyboard Overlay
    ----------------------------- */
    #kbd-overlay{
      position:fixed;
      left:0; top:0;
      width:1920px; height:1080px;
      background: rgba(0,0,0,.72);
      display:none;
      z-index:20000;
      padding:60px 80px;
    }
    #kbd-overlay.active{ display:block; }

    #kbd-panel{
      width:100%;
      height:100%;
      border-radius:26px;
      border:1px solid rgba(0,210,255,.22);
      background: rgba(0,0,0,.35);
      padding:20px;
      display:flex;
      flex-direction:column;
    }

    #kbd-head{
      display:flex;
      flex-direction:column;
      gap:10px;
      border-bottom:1px solid rgba(0,210,255,.16);
      padding-bottom:14px;
      margin-bottom:14px;
    }
    #kbd-title{
      color:var(--cyan);
      font-weight:900;
      letter-spacing:3px;
      font-size:14px;
      text-transform:uppercase;
    }
    #kbd-preview{
      font-weight:900;
      font-size:30px;
      padding:14px;
      border-radius:14px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(0,210,255,.16);
      min-height:60px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }

    #kbd-rows{
      flex:1;
      overflow:hidden;
      padding-top:10px;
    }

    .kbtn{
      border-radius:14px;
      border:1px solid rgba(0,210,255,.18);
      background: rgba(0,0,0,.28);
      padding:16px 10px;
      text-align:center;
      font-weight:900;
      font-size:24px;
      user-select:none;
      transition:.10s;
    }
    .kbtn.danger{
      border-color: rgba(255,77,77,.35);
      background: rgba(255,77,77,.12);
    }
    .kbtn.focused{
      border-color: rgba(0,210,255,.85);
      box-shadow:0 0 18px rgba(0,210,255,.12);
      background: rgba(0,69,255,.18);
      transform: scale(1.03);
    }
    .kbtn.danger.focused{
      border-color: rgba(255,77,77,.85);
      box-shadow:0 0 18px rgba(255,77,77,.20);
      background: rgba(255,77,77,.25);
    }
  </style>
</head>

<body onload="init()">
  <header>
    <div class="brand">BLACK<span>IPTV</span></div>
    <nav id="menu">
      <div id="m0" class="menu-item">TV</div>
      <div id="m1" class="menu-item">FILME</div>
      <div id="m2" class="menu-item">SERIEN</div>
      <div id="m3" class="menu-item">EINSTELLUNG</div>
    </nav>
  </header>

  <main>
    <div class="panel">

      <!-- TV -->
      <div id="tv-view">
        <div class="tv-root">
          <div class="col" id="tv-left" style="width:420px">
            <div class="col-h">
              <span>Kategorien</span>
              <span id="tv-cat-count" style="color:rgba(255,255,255,.5);font-weight:900;font-size:14px"></span>
            </div>
            <div id="tv-cat-list" class="list"></div>
          </div>

          <div class="col" id="tv-mid" style="width:620px">
            <div class="col-h">
              <span>Sender</span>
              <span id="tv-chan-count" style="color:rgba(255,255,255,.5);font-weight:900;font-size:14px"></span>
            </div>
            <div id="tv-chan-list" class="list"></div>
          </div>

          <div class="col" style="flex:1">
            <div class="col-h">
              <span>Player</span>
              <span style="color:rgba(255,255,255,.55);font-weight:900;font-size:14px">OK=Play • 0=Fav • Back=Menu • OK(2x)=Fullscreen</span>
            </div>
            <div class="player">
              <div class="video-box" id="tv-video-box">
                <object id="av-player" type="application/avplayer" style="width:100%;height:100%;display:none;"></object>
                <video id="tv-video" autoplay style="width:100%;height:100%;object-fit:contain;display:none;"></video>
              </div>
              <div class="pinfo">
                <div class="pname" id="tv-now">-</div>
                <div class="phint" id="tv-msg">Wähle ein M3U Profil in EINSTELLUNG → M3U PROFILE</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- VOD -->
      <div id="vod-view">
        <div class="vod-netflix">
          <!-- LEFT: Kategorien -->
          <div class="vod-cat-col">
            <div class="col-h">
              <span id="vod-cat-title">Kategorien</span>
              <span id="vod-cat-count" style="color:rgba(255,255,255,.5);font-weight:900;font-size:14px"></span>
            </div>
            <div id="vod-cat-list" class="list"></div>
          </div>

          <!-- RIGHT: Netflix Grid -->
          <div class="vod-grid-col">
            <div class="col-h">
              <span id="vod-grid-title">Inhalte</span>
              <span id="vod-grid-count" style="color:rgba(255,255,255,.5);font-weight:900;font-size:14px"></span>
            </div>

            <div class="vod-grid-scroll" id="vod-grid-scroll">
              <div id="vod-grid" class="vod-grid"></div>
            </div>

            <!-- Hidden player (keine UI, aber Playback bleibt möglich) -->
            <video id="vod-video" autoplay style="display:none;"></video>
          </div>
        </div>
      </div>

      <!-- SETUP -->
      <div id="setup-view">
        <div class="tabs">
          <div id="t0" class="tab">HINTERGRUND</div>
          <div id="t1" class="tab">M3U PROFILE</div>
          <div id="t2" class="tab">XTREAM PROFILE</div>
          <div id="t3" class="tab">MAC ADRESSE</div>
        </div>

        <div class="content-col">
          <div class="content-header">
            <span id="content-title">HINTERGRUND</span>
            <span id="content-hint" class="hint">Tabs: ←/→ • OK = rein • Zurück = Menü</span>
          </div>
          <div id="content-body" class="content-body"></div>
        </div>
      </div>

    </div>
  </main>

  <!-- Virtual Keyboard -->
  <div id="kbd-overlay">
    <div id="kbd-panel">
      <div id="kbd-head">
        <div id="kbd-title">TASTATUR</div>
        <div id="kbd-preview">-</div>
      </div>
      <div id="kbd-rows"></div>
      <div style="margin-top:10px; color:rgba(255,255,255,.65); font-weight:900; font-size:18px;">
        Navigation: ▲/▼/◀/▶ • OK = Eingabe • BACK = Schließen
      </div>
    </div>
  </div>

<script>
  // -----------------------------
  // Helpers
  // -----------------------------
  function $(id){ return document.getElementById(id); }
  function esc(s){
    return String(s||"")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }
  function nowBust(){ return "t=" + Date.now(); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function uuid(){ return "id_" + Date.now() + "_" + Math.floor(Math.random()*100000); }

  // -----------------------------
  // Player (Samsung Tizen AVPlay + fallback)
  // -----------------------------
  var tvUseAvplay = false;
  var av = null;           // webapis.avplay
  var tvLastUrl = "";
  var tvHls = null;
  var tvFullscreen = false;

  function initPlayer(){
    tvUseAvplay = !!(window.webapis && webapis.avplay);
    if(tvUseAvplay){
      av = webapis.avplay;
      try{ $("av-player").style.display="block"; }catch(e){}
      try{ $("tv-video").style.display="none"; }catch(e){}
      try{
        av.setListener({
          onbufferingstart: function(){},
          onbufferingprogress: function(){},
          onbufferingcomplete: function(){},
          oncurrentplaytime: function(){},
          onevent: function(){},
          onerror: function(){},
          onstreamcompleted: function(){ try{ av.stop(); }catch(e){} }
        });
      }catch(e){}
    }else{
      try{ $("tv-video").style.display="block"; }catch(e){}
      try{ $("av-player").style.display="none"; }catch(e){}
    }
  }

  function applyPlayerRect(full){
    var x=0,y=0,w=1920,h=1080;
    if(!full){
      var box=$("tv-video-box");
      if(box){
        var r=box.getBoundingClientRect();
        x=Math.round(r.left);
        y=Math.round(r.top);
        w=Math.round(r.width);
        h=Math.round(r.height);
      }
    }
    try{
      if(window.tizen && tizen.tvwindow){
        tizen.tvwindow.show(function(){}, function(){});
        tizen.tvwindow.setRect(x,y,w,h);
      }
    }catch(e){}
    if(av){
      try{ av.setDisplayRect(x,y,w,h); }catch(e){}
      try{ av.setDisplayMethod(full ? "PLAYER_DISPLAY_MODE_FULL_SCREEN" : "PLAYER_DISPLAY_MODE_AUTO"); }catch(e){}
    }
  }

  function stopTV(){
    tvLastUrl = "";
    if(tvUseAvplay && av){
      try{ av.stop(); }catch(e){}
      try{ av.close(); }catch(e){}
      return;
    }
    if(tvHls){ try{ tvHls.destroy(); }catch(e){} tvHls=null; }
    var v=$("tv-video");
    if(v){ try{ v.pause(); v.removeAttribute("src"); v.load(); }catch(e){} }
  }

  function playUrl(url){
    if(!url) return;
    tvLastUrl = url;

    if(tvUseAvplay && av){
      try{ av.stop(); }catch(e){}
      try{ av.close(); }catch(e){}
      try{
        av.open(url);
        av.setStreamingProperty && av.setStreamingProperty("ADAPTIVE_INFO", "BITRATE=5000");
        av.prepareAsync(function(){
          applyPlayerRect(tvFullscreen);   // ✅ wichtig
          try{ av.play(); }catch(e){}
        }, function(){
          try{ av.play(); }catch(e){}
        });
      }catch(e){}
      return;
    }

    var v=$("tv-video");
    if(!v) return;

    if(tvHls){ try{ tvHls.destroy(); }catch(e){} tvHls=null; }
    try{ v.pause(); v.removeAttribute("src"); v.load(); }catch(e){}

    if(window.Hls && Hls.isSupported()){
      tvHls = new Hls({enableWorker:true, lowLatencyMode:true, backBufferLength:30});
      tvHls.loadSource(url);
      tvHls.attachMedia(v);
      tvHls.on(Hls.Events.MANIFEST_PARSED, function(){ v.play().catch(function(){}); });
    }else{
      v.src=url;
      v.play().catch(function(){});
    }
  }

  function tvToggleFullscreen(){
    tvFullscreen = !tvFullscreen;
    document.body.classList.toggle("is-fullscreen", tvFullscreen);
    applyPlayerRect(tvFullscreen);
  }

  // -----------------------------
  // App State
  // -----------------------------
  var GH_OWNER = "Artonstyle";
  var GH_REPO  = "IPTVBlack";
  var GH_BG_DIR = "hintergrund";

  var area = "menu"; // menu | tvCats | tvChans | tabs | setupContent | vod | kbd
  var menuIdx = 0;

  var tabIdx = 0;
  var setupFocusIdx = 0;

  var bgItems = [];

  var m3uProfiles = JSON.parse(localStorage.getItem("iptv_m3u_profiles") || "[]");
  var xcProfiles  = JSON.parse(localStorage.getItem("iptv_xc_profiles")  || "[]");
  var activeM3UId = localStorage.getItem("iptv_active_m3u_id") || "";
  var activeXCId  = localStorage.getItem("iptv_active_xc_id")  || "";

  var m3uEditId = "";   // wenn gesetzt: bearbeiten statt neu
  var xcEditId = "";

  var tvCats = [];
  var tvAllChans = [];
  var tvCurChans = [];
  var tvCatIdx = 0;
  var tvChanIdx = 0;
  var tvFavs = JSON.parse(localStorage.getItem("iptv_tv_favs") || "[]");

  var vodMode = "movies";
  var vodRows = [];
  var vodRowIdx = 0;
  var vodItemIdx = 0;
  var vodHls = null;

  function normalizeProfiles(){
    if(!Array.isArray(m3uProfiles)) m3uProfiles=[];
    if(!Array.isArray(xcProfiles))  xcProfiles=[];
    localStorage.setItem("iptv_m3u_profiles", JSON.stringify(m3uProfiles));
    localStorage.setItem("iptv_xc_profiles",  JSON.stringify(xcProfiles));
  }

  // -----------------------------
  // UI show/hide
  // -----------------------------
  function showMain(which){
    $("tv-view").style.display    = (which==="tv")    ? "block" : "none";
    $("vod-view").style.display   = (which==="vod")   ? "block" : "none";
    $("setup-view").style.display = (which==="setup") ? "flex"  : "none";
  }
  function showMainByMenu(idx){
    if(idx===0){
      showMain("tv");
    }else if(idx===1){
      showMain("vod");
      vodMode="movies";
      $("vod-title").innerText="FILME";
    }else if(idx===2){
      showMain("vod");
      vodMode="series";
      $("vod-title").innerText="SERIEN";
    }else{
      showMain("setup");
    }
  }

  function renderMenuFocus(){
    for(var i=0;i<4;i++){
      $("m"+i).classList.toggle("focused", area==="menu" && i===menuIdx);
    }
  }

  // -----------------------------
  // Backgrounds (GitHub)
  // -----------------------------
  function loadBackgroundsFromGitHub(){
    var url="https://api.github.com/repos/"+encodeURIComponent(GH_OWNER)+"/"+encodeURIComponent(GH_REPO)+"/contents/"+encodeURIComponent(GH_BG_DIR)+"?"+nowBust();
    fetch(url)
      .then(function(r){ return r.json(); })
      .then(function(arr){
        var list=[];
        if(Array.isArray(arr)){
          for(var i=0;i<arr.length;i++){
            var it=arr[i];
            if(!it || it.type!=="file") continue;
            var n=(it.name||"").toLowerCase();
            if(!(n.endsWith(".jpg")||n.endsWith(".jpeg")||n.endsWith(".png")||n.endsWith(".webp"))) continue;
            var dl = it.download_url || ("https://raw.githubusercontent.com/"+GH_OWNER+"/"+GH_REPO+"/main/"+GH_BG_DIR+"/"+it.name);
            list.push({ name: it.name, url: dl });
          }
        }
        list.sort(function(a,b){ return a.name.localeCompare(b.name); });
        bgItems=list;
        if(menuIdx===3) renderSetupTabPreview();
      })
      .catch(function(){
        bgItems=[];
        if(menuIdx===3) renderSetupTabPreview();
      });
  }

  function setBackground(url){
    if(!url){
      document.body.style.backgroundImage="";
      document.body.style.background="radial-gradient(circle at top right, #001a4d, #00050a)";
      return;
    }
    document.body.style.backgroundImage =
      "linear-gradient(rgba(0,0,0,.45), rgba(0,0,0,.55)), url('"+url+"?"+nowBust()+"')";
    document.body.style.backgroundSize="cover";
    document.body.style.backgroundPosition="center";
  }

  // -----------------------------
  // Setup Tabs
  // -----------------------------
  function renderSetupTabs(){
    for(var i=0;i<4;i++){
      $("t"+i).classList.toggle("focused", area==="tabs" && i===tabIdx);
    }
  }

  function setSetupTitle(){
    var titles=["HINTERGRUND","M3U PROFILE","XTREAM PROFILE","MAC ADRESSE"];
    $("content-title").innerText = titles[tabIdx];

    if(area==="setupContent"){
      if(tabIdx===0) $("content-hint").innerText = "OK = Hintergrund setzen • 0 = Standard • Zurück = Tabs";
      else if(tabIdx===1) $("content-hint").innerText = "OK = Öffnen • Buttons: OK • Zurück = Tabs";
      else if(tabIdx===2) $("content-hint").innerText = "OK = Öffnen • Buttons: OK • Zurück = Tabs";
      else $("content-hint").innerText = "OK = Aktualisieren • Zurück = Tabs";
    }else{
      $("content-hint").innerText = "Tabs: ←/→ • OK = rein • Zurück = Menü";
    }
  }

  function renderSetupTabPreview(){
    setSetupTitle();
    setupFocusIdx=0;

    if(tabIdx===0) renderBGTab();
    else if(tabIdx===1) renderM3UTab();
    else if(tabIdx===2) renderXCTab();
    else renderMACTab();

    updateFocus();
  }

  function getSetupFocusables(){
    return $("content-body").querySelectorAll(".focusable");
  }

  // -----------------------------
  // BG Tab
  // -----------------------------
  function renderBGTab(){
    var host=$("content-body");
    if(!bgItems.length){
      host.innerHTML =
        '<div class="card2">'+
          '<div class="card2-title">Keine Bilder gefunden</div>'+
          '<div class="card2-sub">Ordner: /'+esc(GH_BG_DIR)+'</div>'+
        '</div>';
      return;
    }
    var html='<div class="tile-wrap">';
    for(var i=0;i<bgItems.length;i++){
      html +=
        '<div class="tile focusable" data-kind="bg" data-idx="'+i+'">'+
          '<img src="'+bgItems[i].url+'?'+nowBust()+'" onerror="this.style.opacity=\'0\';" />'+
          '<div class="label">'+esc(bgItems[i].name)+'</div>'+
        '</div>';
    }
    html+='</div>';
    host.innerHTML=html;
  }

  // -----------------------------
  // MAC Tab
  // -----------------------------
  function getSamsungMac(){
    var mac="unbekannt";
    try{
      if(window.webapis && webapis.network && typeof webapis.network.getMac==="function"){
        mac = webapis.network.getMac() || "unbekannt";
      }
    }catch(e){}
    return mac;
  }

  function renderMACTab(){
    var mac = getSamsungMac();
    $("content-body").innerHTML =
      '<div class="card2 focusable" data-kind="mac" data-idx="0">'+
        '<div class="card2-title">MAC ADRESSE</div>'+
        '<div class="card2-sub" style="font-size:30px">'+esc(mac)+'</div>'+
        '<div class="card2-sub" style="font-size:20px">OK = Aktualisieren</div>'+
      '</div>';
  }

  // -----------------------------
  // Profiles (M3U)
  // -----------------------------
  function saveM3UProfiles(){ localStorage.setItem("iptv_m3u_profiles", JSON.stringify(m3uProfiles)); }
  function setActiveM3U(id){
    activeM3UId = id || "";
    localStorage.setItem("iptv_active_m3u_id", activeM3UId);
  }
  function getActiveM3U(){
    for(var i=0;i<m3uProfiles.length;i++){
      if(m3uProfiles[i].id===activeM3UId) return m3uProfiles[i];
    }
    return null;
  }
  function findM3UById(id){
    for(var i=0;i<m3uProfiles.length;i++) if(m3uProfiles[i].id===id) return m3uProfiles[i];
    return null;
  }
  function deleteM3UById(id){
    var ix=-1;
    for(var i=0;i<m3uProfiles.length;i++){ if(m3uProfiles[i].id===id){ ix=i; break; } }
    if(ix<0) return;
    m3uProfiles.splice(ix,1);
    saveM3UProfiles();
    if(activeM3UId===id){
      setActiveM3U(m3uProfiles[0] ? m3uProfiles[0].id : "");
    }
    if(m3uEditId===id) m3uEditId="";
  }
  function upsertM3U(id, name, url){
    name=(name||"").trim();
    url=(url||"").trim();
    if(!name) name="M3U Profil";
    if(!url) return false;

    if(id){
      var p=findM3UById(id);
      if(!p) return false;
      p.name=name; p.url=url;
      saveM3UProfiles();
      return true;
    }else{
      var p2={ id: uuid(), name:name, url:url };
      m3uProfiles.unshift(p2);
      if(m3uProfiles.length>30) m3uProfiles = m3uProfiles.slice(0,30);
      saveM3UProfiles();
      setActiveM3U(p2.id);
      return true;
    }
  }

  function renderM3UTab(){
    var host=$("content-body");

    var edit = m3uEditId ? findM3UById(m3uEditId) : null;
    var formTitle = edit ? "M3U PROFIL BEARBEITEN" : "NEUES M3U PROFIL";

    var html='';
    html += '<div class="two-col">';

    // LEFT: list
    html += '<div class="left-col">';
    html += '<div class="col-title"><span>GESPEICHERTE M3U</span><span style="color:rgba(255,255,255,.6);font-weight:900;">'+m3uProfiles.length+'</span></div>';
    html += '<div class="profiles-scroll">';

    if(!m3uProfiles.length){
      html += '<div class="card2"><div class="card2-title">Keine Profile</div><div class="card2-sub">Rechts ein Profil anlegen.</div></div>';
    }else{
      for(var i=0;i<m3uProfiles.length;i++){
        var p=m3uProfiles[i];
        var isActive = (p.id && p.id===activeM3UId);
        html += '<div class="prof-row '+(isActive?'active':'')+'">';
        html +=   '<div class="prof-head">';
        html +=     '<div class="prof-name">'+esc(p.name||("Profil "+(i+1)))+(isActive?'<span class="badge active">AKTIV</span>':'')+'</div>';
        html +=   '</div>';
        html +=   '<div class="prof-url">'+esc(p.url||"")+'</div>';
        html +=   '<div class="prof-actions">';
        html +=     '<div class="btn focusable" data-kind="m3u-activate" data-id="'+esc(p.id)+'">Aktivieren</div>';
        html +=     '<div class="btn focusable" data-kind="m3u-edit" data-id="'+esc(p.id)+'">Bearbeiten</div>';
        html +=     '<div class="btn danger focusable" data-kind="m3u-del" data-id="'+esc(p.id)+'">Löschen</div>';
        html +=   '</div>';
        html += '</div>';
      }
    }

    html += '</div>'; // scroll
    html += '</div>'; // left

    // RIGHT: form
    html += '<div class="right-col">';
    html +=   '<div class="col-title"><span>'+formTitle+'</span><span style="color:rgba(255,255,255,.6);font-weight:900;">OK = Tastatur</span></div>';
    html +=   '<div class="card2" style="margin-bottom:0;">';
    html +=     '<div class="label2">NAME</div>';
    html +=     '<input id="m3u-name" class="input focusable" readonly data-kind="m3u-input" data-field="name" placeholder="z.B. Zuhause" value="'+esc(edit?edit.name:"")+'" />';
    html +=     '<div class="label2">M3U URL</div>';
    html +=     '<input id="m3u-url" class="input focusable" readonly data-kind="m3u-input" data-field="url" placeholder="https://example.com/list.m3u" value="'+esc(edit?edit.url:"")+'" />';
    html +=     '<div class="btnrow">';
    html +=       '<div id="m3u-save" class="btn ok focusable" data-kind="m3u-save">'+(edit?'Speichern':'Anlegen')+'</div>';
    html +=       '<div id="m3u-cancel" class="btn focusable" data-kind="m3u-cancel">Abbrechen</div>';
    html +=     '</div>';
    html +=     '<div class="card2-sub" style="font-size:18px; margin-top:12px;">Tipp: OK auf Feld → virtuelle Tastatur</div>';
    html +=   '</div>';
    html += '</div>'; // right

    html += '</div>'; // two-col

    host.innerHTML = html;
  }

  // -----------------------------
  // Profiles (Xtream)
  // -----------------------------
  function saveXCProfiles(){ localStorage.setItem("iptv_xc_profiles", JSON.stringify(xcProfiles)); }
  function setActiveXC(id){
    activeXCId = id || "";
    localStorage.setItem("iptv_active_xc_id", activeXCId);
  }
  function getActiveXC(){
    for(var i=0;i<xcProfiles.length;i++){
      if(xcProfiles[i].id===activeXCId) return xcProfiles[i];
    }
    return null;
  }
  function findXCById(id){
    for(var i=0;i<xcProfiles.length;i++) if(xcProfiles[i].id===id) return xcProfiles[i];
    return null;
  }
  function deleteXCById(id){
    var ix=-1;
    for(var i=0;i<xcProfiles.length;i++){ if(xcProfiles[i].id===id){ ix=i; break; } }
    if(ix<0) return;
    xcProfiles.splice(ix,1);
    saveXCProfiles();
    if(activeXCId===id){
      setActiveXC(xcProfiles[0] ? xcProfiles[0].id : "");
    }
    if(xcEditId===id) xcEditId="";
  }
  function upsertXC(id, name, user, pass, url){
    name=(name||"").trim();
    user=(user||"").trim();
    pass=(pass||"").trim();
    url=(url||"").trim();
    if(!name) name="Xtream Profil";
    if(!user || !pass || !url) return false;
    url = url.replace(/\/+$/,"");

    if(id){
      var p=findXCById(id);
      if(!p) return false;
      p.name=name; p.user=user; p.pass=pass; p.url=url;
      saveXCProfiles();
      return true;
    }else{
      var p2={ id: uuid(), name:name, user:user, pass:pass, url:url };
      xcProfiles.unshift(p2);
      if(xcProfiles.length>30) xcProfiles = xcProfiles.slice(0,30);
      saveXCProfiles();
      setActiveXC(p2.id);
      return true;
    }
  }

  function renderXCTab(){
    var host=$("content-body");

    var edit = xcEditId ? findXCById(xcEditId) : null;
    var formTitle = edit ? "XTREAM PROFIL BEARBEITEN" : "NEUES XTREAM PROFIL";

    var html='';
    html += '<div class="two-col">';

    // LEFT
    html += '<div class="left-col">';
    html += '<div class="col-title"><span>GESPEICHERTE XTREAM</span><span style="color:rgba(255,255,255,.6);font-weight:900;">'+xcProfiles.length+'</span></div>';
    html += '<div class="profiles-scroll">';

    if(!xcProfiles.length){
      html += '<div class="card2"><div class="card2-title">Keine Profile</div><div class="card2-sub">Rechts ein Profil anlegen.</div></div>';
    }else{
      for(var i=0;i<xcProfiles.length;i++){
        var p=xcProfiles[i];
        var isActive = (p.id && p.id===activeXCId);
        html += '<div class="prof-row '+(isActive?'active':'')+'">';
        html +=   '<div class="prof-head">';
        html +=     '<div class="prof-name">'+esc(p.name||("Xtream "+(i+1)))+(isActive?'<span class="badge active">AKTIV</span>':'')+'</div>';
        html +=   '</div>';
        html +=   '<div class="prof-url">User: '+esc(p.user||"")+'</div>';
        html +=   '<div class="prof-url">URL: '+esc(p.url||"")+'</div>';
        html +=   '<div class="prof-actions">';
        html +=     '<div class="btn focusable" data-kind="xc-activate" data-id="'+esc(p.id)+'">Aktivieren</div>';
        html +=     '<div class="btn focusable" data-kind="xc-edit" data-id="'+esc(p.id)+'">Bearbeiten</div>';
        html +=     '<div class="btn danger focusable" data-kind="xc-del" data-id="'+esc(p.id)+'">Löschen</div>';
        html +=   '</div>';
        html += '</div>';
      }
    }

    html += '</div></div>'; // scroll + left

    // RIGHT
    html += '<div class="right-col">';
    html +=   '<div class="col-title"><span>'+formTitle+'</span><span style="color:rgba(255,255,255,.6);font-weight:900;">OK = Tastatur</span></div>';
    html +=   '<div class="card2" style="margin-bottom:0;">';
    html +=     '<div class="label2">NAME</div>';
    html +=     '<input id="xc-name" class="input focusable" readonly data-kind="xc-input" data-field="name" placeholder="z.B. Anbieter A" value="'+esc(edit?edit.name:"")+'" />';
    html +=     '<div class="label2">BENUTZERNAME</div>';
    html +=     '<input id="xc-user" class="input focusable" readonly data-kind="xc-input" data-field="user" placeholder="username" value="'+esc(edit?edit.user:"")+'" />';
    html +=     '<div class="label2">PASSWORT</div>';
    html +=     '<input id="xc-pass" class="input focusable" readonly data-kind="xc-input" data-field="pass" placeholder="password" value="'+esc(edit?edit.pass:"")+'" />';
    html +=     '<div class="label2">URL</div>';
    html +=     '<input id="xc-url" class="input focusable" readonly data-kind="xc-input" data-field="url" placeholder="http://server:port" value="'+esc(edit?edit.url:"")+'" />';
    html +=     '<div class="btnrow">';
    html +=       '<div id="xc-save" class="btn ok focusable" data-kind="xc-save">'+(edit?'Speichern':'Anlegen')+'</div>';
    html +=       '<div id="xc-cancel" class="btn focusable" data-kind="xc-cancel">Abbrechen</div>';
    html +=     '</div>';
    html +=     '<div class="card2-sub" style="font-size:18px; margin-top:12px;">Tipp: OK auf Feld → virtuelle Tastatur</div>';
    html +=   '</div>';
    html += '</div>'; // right

    html += '</div>'; // two-col

    host.innerHTML = html;
  }

  // -----------------------------
  // TV: M3U load/parse
  // -----------------------------
  function tvReloadFromActiveProfile(){
    var p=getActiveM3U();
    tvCats=[]; tvAllChans=[]; tvCurChans=[];
    tvCatIdx=0; tvChanIdx=0;
    $("tv-now").innerText="-";
    if(!p || !p.url){
      $("tv-msg").innerText="Wähle ein M3U Profil in EINSTELLUNG → M3U PROFILE";
      renderTVLists();
      return;
    }
    $("tv-msg").innerText="Lade M3U…";
    loadM3U(p.url);
  }

  function loadM3U(url){
    var xhr=new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.timeout=20000;
    xhr.onreadystatechange=function(){
      if(xhr.readyState!==4) return;
      if(xhr.status===200 && xhr.responseText){
        parseM3U(xhr.responseText);
        buildTVCategories();
        filterTVCategory(tvCats[0] ? tvCats[0].key : "ALL");
        $("tv-msg").innerText="OK=Play • 0=Fav • Back=Menu";
      }else{
        $("tv-msg").innerText="M3U Fehler ("+xhr.status+")";
        tvCats=[]; tvAllChans=[]; tvCurChans=[];
        renderTVLists();
      }
    };
    xhr.ontimeout=function(){
      $("tv-msg").innerText="M3U Timeout";
      tvCats=[]; tvAllChans=[]; tvCurChans=[];
      renderTVLists();
    };
    xhr.send();
  }

  function parseM3U(text){
    var lines=text.split("\n");
    tvAllChans=[];
    var pending=null;
    for(var i=0;i<lines.length;i++){
      var line=(lines[i]||"").trim();
      if(!line) continue;
      if(line.indexOf("#EXTINF")===0){
        var parts=line.split(",");
        var name=(parts.length>1?parts[parts.length-1]:"Unbekannt").trim();
        var g=line.match(/group-title="([^"]*)"/i);
        var group=(g && g[1])?g[1].trim():"Ohne Kategorie";
        pending={name:name,group:group};
        continue;
      }
      if(pending && (line.indexOf("http")===0 || line.indexOf("https")===0)){
        tvAllChans.push({name:pending.name, group:pending.group, url:line});
        pending=null;
        if(tvAllChans.length>=4000) break;
      }
    }
  }

  function buildTVCategories(){
    var counts={};
    for(var i=0;i<tvAllChans.length;i++){
      var g=tvAllChans[i].group || "Ohne Kategorie";
      counts[g]=(counts[g]||0)+1;
    }
    var groups=Object.keys(counts).sort(function(a,b){ return a.localeCompare(b); });
    tvCats=[];
    tvCats.push({key:"ALL", label:"ALL ("+tvAllChans.length+")"});
    tvCats.push({key:"Favoriten", label:"Favoriten ("+tvFavs.length+")"});
    for(var j=0;j<groups.length;j++){
      tvCats.push({key:groups[j], label:groups[j]+" ("+counts[groups[j]]+")"});
    }
  }

  function filterTVCategory(key){
    if(key==="ALL") tvCurChans = tvAllChans.slice();
    else if(key==="Favoriten") tvCurChans = tvAllChans.filter(function(c){ return tvFavs.indexOf(c.url)>-1; });
    else tvCurChans = tvAllChans.filter(function(c){ return (c.group||"Ohne Kategorie")===key; });

    tvChanIdx=0;
    renderTVLists();
  }

  function renderTVLists(){
    var ch="";
    for(var i=0;i<tvCats.length;i++){
      ch += '<div class="entry tv-cat" data-idx="'+i+'">'+esc(tvCats[i].label)+'</div>';
    }
    $("tv-cat-list").innerHTML = ch || '<div style="padding:16px;color:rgba(255,255,255,.6);font-weight:900">Keine Kategorien</div>';
    $("tv-cat-count").innerText = tvCats.length ? (tvCats.length+"") : "";

    var hh="";
    for(var j=0;j<tvCurChans.length;j++){
      var c=tvCurChans[j];
      var isFav = (tvFavs.indexOf(c.url)>-1);
      hh += '<div class="entry tv-chan'+(isFav?' is-fav':'')+'" data-idx="'+j+'">'+
              '<span class="chan-num">'+(j+1)+'</span>'+
              '<span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+esc(c.name)+'</span>'+
              '<span class="star">★</span>'+
            '</div>';
    }
    $("tv-chan-list").innerHTML = hh || '<div style="padding:16px;color:rgba(255,255,255,.6);font-weight:900">Keine Sender</div>';
    $("tv-chan-count").innerText = tvCurChans.length ? (tvCurChans.length+"") : "";

    updateFocus();
  }

  function tvPlayCurrent(){
    if(!tvCurChans || !tvCurChans.length || !tvCurChans[tvChanIdx]) return;
    var ch = tvCurChans[tvChanIdx];
    $("tv-now").innerText = ch.name || "Kanal";
    $("tv-msg").innerText = "OK=Play • 0=Fav • Back=Menu • OK(2x)=Fullscreen";
    playUrl(ch.url);
  }

  function tvToggleFav(){
    if(!tvCurChans[tvChanIdx]) return;
    var url = tvCurChans[tvChanIdx].url;
    var ix = tvFavs.indexOf(url);
    if(ix>-1) tvFavs.splice(ix,1); else tvFavs.push(url);
    localStorage.setItem("iptv_tv_favs", JSON.stringify(tvFavs));
    buildTVCategories();
    var catKey = tvCats[tvCatIdx] ? tvCats[tvCatIdx].key : "ALL";
    filterTVCategory(catKey);
  }

  // -----------------------------
  // VOD (unchanged)
  // -----------------------------
  function fetchJSON(url){ return fetch(url).then(function(r){ return r.json(); }); }

  function vodReloadFromActiveProfile(){
    vodRows=[];
    vodRowIdx=0; vodItemIdx=0;
    $("vod-info-title").innerText="-";
    $("vod-info-sub").innerText="-";

    var xc=getActiveXC();
    if(!xc){
      $("vod-sub").innerText="Aktives Xtream Profil wird benötigt (EINSTELLUNG → XTREAM PROFILE)";
      $("vod-rows").innerHTML = '<div style="padding:24px;color:rgba(255,255,255,.7);font-weight:900;font-size:26px">Kein aktives Xtream Profil</div>';
      return;
    }
    $("vod-sub").innerText="Lade Inhalte von: "+xc.name;
    vodLoadRows(xc, vodMode);
  }

  function xtreamApi(xc, action){
    return xc.url + "/player_api.php?username=" + encodeURIComponent(xc.user) + "&password=" + encodeURIComponent(xc.pass) + "&action=" + encodeURIComponent(action);
  }
  function vodStreamUrlMovie(xc, streamId){
    return xc.url + "/movie/" + encodeURIComponent(xc.user) + "/" + encodeURIComponent(xc.pass) + "/" + encodeURIComponent(streamId) + ".mp4";
  }

  function vodLoadRows(xc, mode){
    var rowsHost=$("vod-rows");
    rowsHost.innerHTML = '<div style="padding:24px;color:rgba(255,255,255,.7);font-weight:900;font-size:26px">Lade…</div>';

    if(mode==="movies"){
      fetchJSON(xtreamApi(xc, "get_vod_categories"))
        .then(function(cats){
          if(!Array.isArray(cats)) cats=[];
          cats = cats.slice(0, 12);
          var chain = Promise.resolve([]);
          cats.forEach(function(cat){
            chain = chain.then(function(acc){
              var catId = cat.category_id;
              return fetchJSON(xtreamApi(xc, "get_vod_streams") + "&category_id=" + encodeURIComponent(catId))
                .then(function(items){
                  if(!Array.isArray(items)) items=[];
                  items = items.slice(0, 20);
                  var rowItems = items.map(function(it){
                    return {
                      name: it.name || "Unbekannt",
                      poster: it.stream_icon || "",
                      url: vodStreamUrlMovie(xc, it.stream_id),
                      meta: "Movie • ID " + (it.stream_id||"")
                    };
                  });
                  acc.push({ title: cat.category_name || "Kategorie", items: rowItems });
                  return acc;
                })
                .catch(function(){
                  acc.push({ title: cat.category_name || "Kategorie", items: [] });
                  return acc;
                });
            });
          });

          return chain.then(function(rows){
            vodRows = rows;
            renderVODRows();
          });
        })
        .catch(function(){
          rowsHost.innerHTML = '<div style="padding:24px;color:rgba(255,255,255,.75);font-weight:900;font-size:26px">Xtream Fehler beim Laden (Filme)</div>';
        });
    }else{
      fetchJSON(xtreamApi(xc, "get_series_categories"))
        .then(function(cats){
          if(!Array.isArray(cats)) cats=[];
          cats = cats.slice(0, 12);
          var chain = Promise.resolve([]);
          cats.forEach(function(cat){
            chain = chain.then(function(acc){
              var catId = cat.category_id;
              return fetchJSON(xtreamApi(xc, "get_series") + "&category_id=" + encodeURIComponent(catId))
                .then(function(items){
                  if(!Array.isArray(items)) items=[];
                  items = items.slice(0, 20);
                  var rowItems = items.map(function(it){
                    return {
                      name: it.name || "Unbekannt",
                      poster: it.cover || it.stream_icon || "",
                      url: "",
                      meta: "Serie • ID " + (it.series_id||""),
                      series_id: it.series_id
                    };
                  });
                  acc.push({ title: cat.category_name || "Kategorie", items: rowItems });
                  return acc;
                })
                .catch(function(){
                  acc.push({ title: cat.category_name || "Kategorie", items: [] });
                  return acc;
                });
            });
          });

          return chain.then(function(rows){
            vodRows = rows;
            renderVODRows();
          });
        })
        .catch(function(){
          rowsHost.innerHTML = '<div style="padding:24px;color:rgba(255,255,255,.75);font-weight:900;font-size:26px">Xtream Fehler beim Laden (Serien)</div>';
        });
    }
  }

  function renderVODRows(){
    // LEFT: Kategorien (vodRows = Kategorienliste)
    var catHost = $("vod-cat-list");
    var gridHost = $("vod-grid");

    if(!catHost || !gridHost){
      // Fallback: falls HTML nicht geladen ist
      return;
    }

    if(!vodRows.length){
      catHost.innerHTML = '<div style="padding:16px;color:rgba(255,255,255,.6);font-weight:900">Keine Kategorien</div>';
      gridHost.innerHTML = '';
      if($("vod-cat-count")) $("vod-cat-count").innerText = "";
      if($("vod-grid-count")) $("vod-grid-count").innerText = "";
      return;
    }

    vodRowIdx = clamp(vodRowIdx, 0, vodRows.length-1);
    var row = vodRows[vodRowIdx];
    var items = (row && row.items) ? row.items : [];
    vodItemIdx = clamp(vodItemIdx, 0, Math.max(0, items.length-1));

    var ch = "";
    for(var i=0;i<vodRows.length;i++){
      ch += '<div class="entry vod-cat focusable' + (i===vodRowIdx ? ' focused' : '') + '" data-idx="'+i+'">' +
              esc(vodRows[i].title) +
            '</div>';
    }
    catHost.innerHTML = ch;

    var gh = "";
    for(var j=0;j<items.length;j++){
      var it = items[j] || {};
      var poster = it.poster ? (it.poster + (it.poster.indexOf("?")>-1 ? "&" : "?") + nowBust()) : "";
      gh += '<div class="vod-tile focusable' + (j===vodItemIdx ? ' focused' : '') + '" data-idx="'+j+'">' +
              (poster ? '<img src="'+poster+'" onerror="this.src='';this.style.background='#000';" />' : '<div style="position:absolute;inset:0;background:#000"></div>') +
              '<div class="cap">'+esc(it.name||"")+'</div>' +
            '</div>';
    }
    gridHost.innerHTML = gh || '<div style="padding:16px;color:rgba(255,255,255,.6);font-weight:900">Keine Inhalte</div>';

    if($("vod-cat-count")) $("vod-cat-count").innerText = vodRows.length ? (vodRows.length+"") : "";
    if($("vod-grid-count")) $("vod-grid-count").innerText = items.length ? (items.length+"") : "";

    // optional: Titel oben rechts anpassen
    if($("vod-grid-title")) $("vod-grid-title").innerText = row ? row.title : "Inhalte";
  }

  function vodUpdateInfoPanel(){
    // UI wurde entfernt – Funktion bleibt als Guard, damit kein Fehler kommt
    return;
  }

  function vodUpdateFocusAndScroll(){
    // Kategorien Fokus
    var cats = $("vod-cat-list") ? $("vod-cat-list").getElementsByClassName("vod-cat") : [];
    for(var i=0;i<cats.length;i++){
      cats[i].classList.toggle("focused", i===vodRowIdx);
      if(i===vodRowIdx){
        try{ cats[i].scrollIntoView({block:"center"}); }catch(e){}
      }
    }

    // Tiles Fokus
    var grid = $("vod-grid");
    if(!grid) return;

    var tiles = grid.getElementsByClassName("vod-tile");
    for(var j=0;j<tiles.length;j++){
      tiles[j].classList.toggle("focused", j===vodItemIdx);
      if(j===vodItemIdx){
        try{ tiles[j].scrollIntoView({block:"nearest", inline:"nearest"}); }catch(e){}
      }
    }
  }

  function vodStopVideo(){
    var v=$("vod-video");
    if(vodHls){ try{ vodHls.destroy(); }catch(e){} vodHls=null; }
    try{ v.pause(); v.removeAttribute("src"); v.load(); }catch(e){}
  }

  function vodPlayUrl(url){
    var v=$("vod-video");
    vodStopVideo();
    if(window.Hls && Hls.isSupported()){
      vodHls = new Hls({ enableWorker:true, lowLatencyMode:true, backBufferLength:30 });
      vodHls.loadSource(url);
      vodHls.attachMedia(v);
      vodHls.on(Hls.Events.MANIFEST_PARSED, function(){
        v.play().catch(function(){});
      });
    }else{
      v.src=url;
      v.play().catch(function(){});
    }
  }

  function vodPlayCurrent(){
    var xc=getActiveXC();
    if(!xc) return;
    var row=vodRows[vodRowIdx];
    if(!row || !row.items || !row.items[vodItemIdx]) return;
    var it=row.items[vodItemIdx];
    if(vodMode==="movies"){
      if(!it.url) return;
      vodPlayUrl(it.url);
      return;
    }
    $("vod-info-sub").innerText="Serien-Play kommt als nächstes (Episode-Auswahl).";
  }

  // -----------------------------
  // Virtual Keyboard (FIXED)
  // -----------------------------
  var kbdActive = false;
  var kbdTargetId = "";
  var kbdCaps = false;
  var kbdRow = 0;
  var kbdCol = 0;
  var kbdLayout = [];

  function buildKbdLayout(){
    var r1 = "1234567890".split("").map(function(ch){ return {t:ch,a:"char"}; });
    r1.push({t:".",a:"char"},{t:"-",a:"char"},{t:"_",a:"char"},{t:":",a:"char"},{t:"/",a:"char"});

    var r2 = "qwertyuiop".split("").map(function(ch){ return {t:ch,a:"char"}; });
    r2.push({t:"?",a:"char"},{t:"&",a:"char"},{t:"=",a:"char"},{t:"@",a:"char"});

    var r3 = "asdfghjkl".split("").map(function(ch){ return {t:ch,a:"char"}; });
    r3.push({t:"+",a:"char"},{t:"(",a:"char"},{t:")",a:"char"},{t:"[",a:"char"},{t:"]",a:"char"});

    var r4 = "zxcvbnm".split("").map(function(ch){ return {t:ch,a:"char"}; });
    r4.push({t:"%",a:"char"},{t:"#",a:"char"},{t:"!",a:"char"});

    var r5 = [
      {t:"CAPS", a:"caps"},
      {t:"SPACE", a:"space"},
      {t:"BACK", a:"backspace", danger:true},
      {t:"CLEAR", a:"clear", danger:true},
      {t:"DONE", a:"done"}
    ];
    return [r1,r2,r3,r4,r5];
  }

  function renderKeyboard(){
    kbdLayout = buildKbdLayout();
    var host = $("kbd-rows");
    var html = "";

    for(var r=0; r<kbdLayout.length; r++){
      html += '<div class="kbd-row" style="display:flex; gap:10px; margin-bottom:10px;">';
      for(var c=0; c<kbdLayout[r].length; c++){
        var k = kbdLayout[r][c];
        var cls = "kbtn";
        if(k.danger) cls += " danger";
        var style = "";
        if(k.a==="space") style = "flex:1.6;";
        else if(k.a==="caps" || k.a==="done") style = "flex:1.0;";
        else style = "flex:0.65;";
        html += '<div class="'+cls+'" style="'+style+'" data-r="'+r+'" data-c="'+c+'">'+esc(k.t)+'</div>';
      }
      html += "</div>";
    }

    host.innerHTML = html;
    kbdRow = clamp(kbdRow, 0, kbdLayout.length-1);
    kbdCol = clamp(kbdCol, 0, kbdLayout[kbdRow].length-1);
    kbdUpdateFocus();
  }

  function kbdUpdatePreview(){
    var inp = $(kbdTargetId);
    $("kbd-preview").innerText = inp ? (inp.value || "") : "";
  }

  function kbdUpdateFocus(){
    var btns = $("kbd-rows").querySelectorAll(".kbtn");
    for(var i=0;i<btns.length;i++) btns[i].classList.remove("focused");
    var sel = '.kbtn[data-r="'+kbdRow+'"][data-c="'+kbdCol+'"]';
    var el = document.querySelector(sel);
    if(el) el.classList.add("focused");
    $("kbd-title").innerText = "TASTATUR" + (kbdCaps ? " (CAPS)" : "");
    kbdUpdatePreview();
  }

  function openKeyboard(inputId){
    kbdTargetId = inputId;
    kbdActive = true;
    area = "kbd";
    $("kbd-overlay").classList.add("active");
    kbdRow = 0; kbdCol = 0;
    renderKeyboard();
  }

  function closeKeyboard(){
    kbdActive = false;
    $("kbd-overlay").classList.remove("active");
    area = "setupContent";
    updateFocus();
  }

  function kbdGetKey(){
    if(!kbdLayout.length) return null;
    if(!kbdLayout[kbdRow]) return null;
    return kbdLayout[kbdRow][kbdCol] || null;
  }

  function kbdPutChar(ch){
    var inp = $(kbdTargetId);
    if(!inp) return;
    var out = ch;
    if(kbdCaps && /^[a-z]$/i.test(out)) out = out.toUpperCase();
    inp.value = (inp.value || "") + out;
    kbdUpdatePreview();
  }

  function kbdBackspace(){
    var inp = $(kbdTargetId);
    if(!inp) return;
    var v = inp.value || "";
    inp.value = v.slice(0, Math.max(0, v.length-1));
    kbdUpdatePreview();
  }

  function kbdClear(){
    var inp = $(kbdTargetId);
    if(!inp) return;
    inp.value = "";
    kbdUpdatePreview();
  }

  function kbdSpace(){
    var inp = $(kbdTargetId);
    if(!inp) return;
    inp.value = (inp.value || "") + " ";
    kbdUpdatePreview();
  }

  function kbdPress(){
    var k = kbdGetKey();
    if(!k) return;

    if(k.a==="char") kbdPutChar(k.t);
    else if(k.a==="space") kbdSpace();
    else if(k.a==="backspace") kbdBackspace();
    else if(k.a==="clear") kbdClear();
    else if(k.a==="caps") kbdCaps = !kbdCaps;
    else if(k.a==="done") closeKeyboard();

    kbdUpdateFocus();
  }

  function handleKbdKeys(keyCode){
    if(area!=="kbd") return false;

    if(keyCode===37){ kbdCol = Math.max(0, kbdCol-1); kbdUpdateFocus(); return true; }
    if(keyCode===39){ kbdCol = Math.min(kbdLayout[kbdRow].length-1, kbdCol+1); kbdUpdateFocus(); return true; }
    if(keyCode===38){
      kbdRow = Math.max(0, kbdRow-1);
      kbdCol = Math.min(kbdCol, kbdLayout[kbdRow].length-1);
      kbdUpdateFocus();
      return true;
    }
    if(keyCode===40){
      kbdRow = Math.min(kbdLayout.length-1, kbdRow+1);
      kbdCol = Math.min(kbdCol, kbdLayout[kbdRow].length-1);
      kbdUpdateFocus();
      return true;
    }
    if(keyCode===13){ kbdPress(); return true; }
    if(keyCode===10009 || keyCode===27){ closeKeyboard(); return true; }

    return true;
  }

  // -----------------------------
  // Focus & Navigation
  // -----------------------------
  function updateFocus(){
    renderMenuFocus();

    if($("setup-view").style.display==="flex"){
      for(var t=0;t<4;t++){
        $("t"+t).classList.toggle("focused", area==="tabs" && t===tabIdx);
      }
      setSetupTitle();

      var f=getSetupFocusables();
      for(var j=0;j<f.length;j++) f[j].classList.remove("focused");
      if(area==="setupContent" && f.length){
        setupFocusIdx=clamp(setupFocusIdx,0,f.length-1);
        f[setupFocusIdx].classList.add("focused");
        try{ f[setupFocusIdx].scrollIntoView({block:"center"}); }catch(e){}
      }
    }

    if($("tv-view").style.display==="block"){
      var cats=$("tv-cat-list").getElementsByClassName("tv-cat");
      for(var c=0;c<cats.length;c++){
        cats[c].classList.toggle("focused", area==="tvCats" && c===tvCatIdx);
        if(area==="tvCats" && c===tvCatIdx) try{ cats[c].scrollIntoView({block:"center"});}catch(e){}
      }
      var chans=$("tv-chan-list").getElementsByClassName("tv-chan");
      for(var d=0;d<chans.length;d++){
        chans[d].classList.toggle("focused", area==="tvChans" && d===tvChanIdx);
        if(area==="tvChans" && d===tvChanIdx) try{ chans[d].scrollIntoView({block:"center"});}catch(e){}
      }
    }

    if($("vod-view").style.display==="block" && area==="vod"){
      vodUpdateFocusAndScroll();
      vodUpdateInfoPanel();
    }
  }

  // -----------------------------
  // Key Handling
  // -----------------------------
  document.addEventListener("keydown", function(e){
    var k=e.keyCode;

    // ✅ Keyboard overlay has priority
    if(handleKbdKeys(k)) return;

    if(k===10009 || k===27){
      if(tvFullscreen){
        tvToggleFullscreen();
        return;
      }
      if(area==="setupContent"){ area="tabs"; updateFocus(); return; }
      if(area==="tabs"){ area="menu"; updateFocus(); return; }
      if(area==="tvCats" || area==="tvChans"){ area="menu"; updateFocus(); return; }
      if(area==="vod"){ area="menu"; vodStopVideo(); updateFocus(); return; }

      try{ tizen.application.getCurrentApplication().exit(); }catch(ex){}
      return;
    }

    if(tvFullscreen){
      if(k===38){ if(tvChanIdx>0) tvChanIdx--; tvPlayCurrent(); return; }
      if(k===40){ if(tvChanIdx<tvCurChans.length-1) tvChanIdx++; tvPlayCurrent(); return; }
      if(k===13){ tvToggleFullscreen(); return; }
      if(k===48){ tvToggleFav(); return; }
      return;
    }

    // MENU
    if(area==="menu"){
      if(k===37){
        menuIdx = (menuIdx>0)?menuIdx-1:3;
        showMainByMenu(menuIdx);
        if(menuIdx===0) tvReloadFromActiveProfile();
        if(menuIdx===1 || menuIdx===2) vodReloadFromActiveProfile();
        if(menuIdx===3){ renderSetupTabs(); renderSetupTabPreview(); }
        updateFocus();
        return;
      }
      if(k===39){
        menuIdx = (menuIdx<3)?menuIdx+1:0;
        showMainByMenu(menuIdx);
        if(menuIdx===0) tvReloadFromActiveProfile();
        if(menuIdx===1 || menuIdx===2) vodReloadFromActiveProfile();
        if(menuIdx===3){ renderSetupTabs(); renderSetupTabPreview(); }
        updateFocus();
        return;
      }
      if(k===13 || k===40){
        if(menuIdx===0){ area="tvCats"; updateFocus(); return; }
        if(menuIdx===1 || menuIdx===2){ area="vod"; updateFocus(); return; }
        if(menuIdx===3){ area="tabs"; updateFocus(); return; }
      }
      updateFocus();
      return;
    }

    // Tabs
    if(area==="tabs"){
      if(k===37){
        tabIdx=(tabIdx>0)?tabIdx-1:3;
        renderSetupTabs();
        renderSetupTabPreview();
        return;
      }
      if(k===39){
        tabIdx=(tabIdx<3)?tabIdx+1:0;
        renderSetupTabs();
        renderSetupTabPreview();
        return;
      }
      if(k===13 || k===40){
        area="setupContent";
        setupFocusIdx=0;
        updateFocus();
        return;
      }
      updateFocus();
      return;
    }

    // Setup Content
    if(area==="setupContent"){
      var f=getSetupFocusables();
      var len=f.length;

      if(tabIdx===0 && k===48){
        setBackground(null);
        return;
      }

      if(k===38){
        if(setupFocusIdx===0){ area="tabs"; updateFocus(); return; }
        setupFocusIdx=Math.max(0, setupFocusIdx-1);
        updateFocus();
        return;
      }
      if(k===40){
        if(len) setupFocusIdx=Math.min(len-1, setupFocusIdx+1);
        updateFocus();
        return;
      }
      // Optional left/right: move to neighbor in DOM direction
      if(k===37){
        if(len) setupFocusIdx=Math.max(0, setupFocusIdx-1);
        updateFocus();
        return;
      }
      if(k===39){
        if(len) setupFocusIdx=Math.min(len-1, setupFocusIdx+1);
        updateFocus();
        return;
      }

      if(k===13 && len){
        var el=f[setupFocusIdx];
        var kind=(el.getAttribute("data-kind")||"");
        var id=(el.getAttribute("data-id")||"");

        // BG
        if(kind==="bg"){
          var idx=parseInt(el.getAttribute("data-idx")||"-1",10);
          if(bgItems[idx]) setBackground(bgItems[idx].url);
          return;
        }

        // MAC
        if(kind==="mac"){
          renderMACTab();
          area="setupContent";
          setupFocusIdx=0;
          updateFocus();
          return;
        }

        // M3U
        if(kind==="m3u-input"){
          openKeyboard(el.id);
          return;
        }
        if(kind==="m3u-save"){
          var name = $("m3u-name") ? $("m3u-name").value : "";
          var url  = $("m3u-url") ? $("m3u-url").value : "";
          if(upsertM3U(m3uEditId, name, url)){
            if(!m3uEditId){
              // schon gesetzt in upsertM3U via setActiveM3U bei neu
            }else{
              // aktiv lassen
            }
            m3uEditId="";
            renderM3UTab();
            updateFocus();
            tvReloadFromActiveProfile();
          }
          return;
        }
        if(kind==="m3u-cancel"){
          m3uEditId="";
          renderM3UTab();
          updateFocus();
          return;
        }
        if(kind==="m3u-activate"){
          if(id){ setActiveM3U(id); renderM3UTab(); updateFocus(); tvReloadFromActiveProfile(); }
          return;
        }
        if(kind==="m3u-edit"){
          if(id){ m3uEditId=id; renderM3UTab(); setupFocusIdx=0; updateFocus(); }
          return;
        }
        if(kind==="m3u-del"){
          if(id){ deleteM3UById(id); renderM3UTab(); setupFocusIdx=0; updateFocus(); tvReloadFromActiveProfile(); }
          return;
        }

        // XTREAM
        if(kind==="xc-input"){
          openKeyboard(el.id);
          return;
        }
        if(kind==="xc-save"){
          var n = $("xc-name") ? $("xc-name").value : "";
          var u = $("xc-user") ? $("xc-user").value : "";
          var p = $("xc-pass") ? $("xc-pass").value : "";
          var s = $("xc-url")  ? $("xc-url").value  : "";
          if(upsertXC(xcEditId, n, u, p, s)){
            xcEditId="";
            renderXCTab();
            updateFocus();
            vodReloadFromActiveProfile();
          }
          return;
        }
        if(kind==="xc-cancel"){
          xcEditId="";
          renderXCTab();
          updateFocus();
          return;
        }
        if(kind==="xc-activate"){
          if(id){ setActiveXC(id); renderXCTab(); updateFocus(); vodReloadFromActiveProfile(); }
          return;
        }
        if(kind==="xc-edit"){
          if(id){ xcEditId=id; renderXCTab(); setupFocusIdx=0; updateFocus(); }
          return;
        }
        if(kind==="xc-del"){
          if(id){ deleteXCById(id); renderXCTab(); setupFocusIdx=0; updateFocus(); vodReloadFromActiveProfile(); }
          return;
        }
      }

      updateFocus();
      return;
    }

    // TV nav
    if(area==="tvCats"){
      if(k===38){ if(tvCatIdx>0) tvCatIdx--; updateFocus(); return; }
      if(k===40){ if(tvCatIdx<tvCats.length-1) tvCatIdx++; updateFocus(); return; }
      if(k===39 || k===13){
        area="tvChans";
        var key = tvCats[tvCatIdx] ? tvCats[tvCatIdx].key : "ALL";
        filterTVCategory(key);
        updateFocus();
        return;
      }
      if(k===37){ area="menu"; updateFocus(); return; }
      updateFocus();
      return;
    }
    if(area==="tvChans"){
      if(k===37){ area="tvCats"; updateFocus(); return; }
      if(k===38){
        if(tvChanIdx>0) tvChanIdx--;
        updateFocus();
        tvPlayCurrent();
        return;
      }
      if(k===40){ if(tvChanIdx<tvCurChans.length-1) tvChanIdx++; updateFocus(); return; }
      if(k===48){ tvToggleFav(); return; }
      if(k===13){
        if($("tv-now").innerText=== (tvCurChans[tvChanIdx] ? tvCurChans[tvChanIdx].name : "")){
          tvToggleFullscreen();
        }else{
          tvPlayCurrent();
        }
        return;
      }
      updateFocus();
      return;
    }

    // VOD nav
    if(area==="vod"){
      if(!vodRows.length){
        if(k===13){ vodReloadFromActiveProfile(); return; }
        if(k===37){ area="menu"; updateFocus(); return; }
        return;
      }

      if(k===38){
        if(vodRowIdx>0){
          vodRowIdx--;
          vodItemIdx=0;
          renderVODRows();
        }
        vodUpdateFocusAndScroll();
        return;
      }
      if(k===40){
        if(vodRowIdx<vodRows.length-1){
          vodRowIdx++;
          vodItemIdx=0;
          renderVODRows();
        }
        vodUpdateFocusAndScroll();
        return;
      }
      if(k===37){
        if(vodItemIdx>0){
          vodItemIdx--;
          vodUpdateFocusAndScroll();
        }
        return;
      }
      if(k===39){
        var count=(vodRows[vodRowIdx].items||[]).length;
        if(vodItemIdx<count-1){
          vodItemIdx++;
          vodUpdateFocusAndScroll();
        }
        return;
      }
      if(k===13){ vodPlayCurrent(); return; }

      updateFocus();
      return;
    }
  });

  // -----------------------------
  // Init
  // -----------------------------
  function init(){
    try{
      ["Up","Down","Left","Right","Enter","Back","0"].forEach(function(k){
        tizen.tvinputdevice.registerKey(k);
      });
    }catch(e){}

    normalizeProfiles();

    initPlayer();
    setTimeout(function(){ applyPlayerRect(false); }, 50);

    menuIdx=0;
    area="menu";
    showMainByMenu(menuIdx);

    renderMenuFocus();
    renderSetupTabs();
    renderSetupTabPreview();

    loadBackgroundsFromGitHub();

    tvReloadFromActiveProfile();
    vodReloadFromActiveProfile();

    updateFocus();
  }
</script>
</body>
</html>
