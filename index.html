<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Black IPTV 2026 – Samsung Tizen</title>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script type="text/javascript" src="$WEBAPIS/webapis/webapis.js"></script>

  <style>
    :root{
      --blue:#0045ff;
      --cyan:#00d2ff;
      --glass:rgba(0,40,120,.22);
      --glass2:rgba(0,0,0,.26);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.40);
      --danger:#ff4d4d;
      --gold:#ffcc00;
    }
    *{box-sizing:border-box; outline:none}
    body{
      width:1920px;height:1080px;margin:0;
      background: radial-gradient(circle at top right, #001a4d, #00050a);
      background-size:cover;background-position:center;
      color:#fff;font-family: Arial, sans-serif; overflow:hidden;
    }

    header{
      height:160px;
      display:flex; justify-content:space-between; align-items:center;
      padding:0 60px;
      border-bottom:2px solid rgba(0,210,255,.15);
      gap:24px;
    }
    .brand{font-size:52px; font-weight:900; letter-spacing:-1px; min-width:340px}
    .brand span{color:var(--cyan); font-style:italic}

    .header-right{
      min-width:320px;
      display:flex;
      align-items:flex-end;
      justify-content:flex-end;
      flex-direction:column;
      gap:8px;
      padding-right:10px;
    }
    #clock{
      font-weight:900;
      font-size:30px;
      letter-spacing:.8px;
      color:#fff;
      text-shadow:0 2px 14px rgba(0,0,0,.55);
    }
    #date{
      font-weight:900;
      font-size:16px;
      letter-spacing:2px;
      text-transform:uppercase;
      color:rgba(255,255,255,.65);
    }

    #menu{display:flex; gap:18px; flex:1; justify-content:center}
    .menu-item{
      padding:18px 38px;
      font-size:34px;
      font-weight:900;
      color:rgba(255,255,255,.35);
      border-radius:16px;
      transition:.12s;
      user-select:none;
      white-space:nowrap;
    }
    .menu-item.focused{
      background:var(--blue);
      color:#fff;
      box-shadow:0 0 30px rgba(0,69,255,.75);
      transform:scale(1.04);
    }

    main{height:920px; padding:40px 60px}

    .panel{
      height:100%;
      border-radius:32px;
      background: var(--glass);
      border:1px solid rgba(0,210,255,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    #tv-view, #vod-view, #sport-view, #setup-view { height:100%; display:none; }

    /* -----------------------------
       STRONG FOCUS (kräftiger)
    ----------------------------- */
    .focus-strong{
      border:4px solid rgba(0,210,255,1) !important;
      box-shadow:0 0 35px rgba(0,210,255,1) !important;
      background: rgba(0,69,255,.22) !important;
      transform: scale(1.03);
      color:#fff !important;
    }

    /* -----------------------------
       TV VIEW (unverändert + stronger focus)
    ----------------------------- */
    .tv-root{
      height:100%;
      display:flex;
      gap:24px;
      padding:22px;
    }
    .col{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(0,210,255,.14);
      border-radius:26px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .col-h{
      padding:18px 20px;
      color:var(--cyan);
      font-weight:900;
      letter-spacing:3px;
      font-size:14px;
      text-transform:uppercase;
      border-bottom:1px solid rgba(0,210,255,.10);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .list{
      flex:1;
      overflow-y:auto;
      padding:14px;
    }
    .list::-webkit-scrollbar{ width:0; }

    .entry{
      border-radius:16px;
      border:1px solid rgba(0,210,255,.12);
      background: rgba(0,0,0,.24);
      padding:16px 16px;
      margin-bottom:12px;
      transition:.12s;
      color:rgba(255,255,255,.82);
      font-weight:900;
      font-size:26px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .entry.focused{
      border:4px solid rgba(0,210,255,1);
      box-shadow:0 0 35px rgba(0,210,255,1);
      transform: scale(1.03);
      background: rgba(0,69,255,.22);
      color:#fff;
    }
    .chan-num{
      color:var(--cyan);
      font-weight:900;
      font-size:18px;
      min-width:42px;
      opacity:.85;
    }
    .star{
      margin-left:auto;
      font-size:26px;
      color:transparent;
      -webkit-text-stroke:2px var(--gold);
      text-shadow:0 0 10px rgba(255,204,0,.2);
    }
    .is-fav .star{
      color:var(--gold);
      -webkit-text-stroke:0px transparent;
      text-shadow:0 0 12px rgba(255,204,0,.55);
    }

    .player{
      flex:1.2;
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:14px;
    }
    .video-box{
      background:#000;
      border:2px solid rgba(0,210,255,.22);
      border-radius:26px;
      overflow:hidden;
      height:auto;
      position:relative;
      aspect-ratio:16/9;
      max-height:520px;
    }
    video{width:100%;height:100%;object-fit:contain}
    .pinfo{
      padding:14px 14px 8px 14px;
      display:flex; flex-direction:column; gap:8px;
    }
    .pname{ font-size:44px; font-weight:900; }
    .phint{ color:rgba(255,255,255,.55); font-size:18px; font-weight:800; letter-spacing:.2px; }

    /* Fullscreen TV */
    body.is-fullscreen header{ display:none!important; }
    body.is-fullscreen #tv-left,
    body.is-fullscreen #tv-mid,
    body.is-fullscreen .pinfo{ display:none!important; }
    body.is-fullscreen main{
      padding:0!important;
      margin:0!important;
      height:1080px!important;
      width:1920px!important;
    }
    body.is-fullscreen .video-box{
      position:fixed;
      left:0; top:0;
      width:1920px; height:1080px;
      z-index:9999;
      border:none; border-radius:0;
      max-height:none;
    }
    body.is-fullscreen video{ object-fit:contain; }

    /* -----------------------------
       VOD Netflix View (Kategorien links + Grid rechts)
       (Topbar/Player bleiben im HTML, aber nicht genutzt)
    ----------------------------- */
    .vod-netflix{
      height:100%;
      display:flex;
      gap:22px;
      padding:22px;
    }
    .vod-left{
      width:520px;
      border-radius:26px;
      border:1px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .vod-right{
      flex:1;
      border-radius:26px;
      border:1px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .vod-head{
      padding:18px 20px;
      color:var(--cyan);
      font-weight:900;
      letter-spacing:3px;
      font-size:14px;
      text-transform:uppercase;
      border-bottom:1px solid rgba(0,210,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .vod-status{
      color:rgba(255,255,255,.65);
      font-weight:900;
      font-size:14px;
      letter-spacing:1px;
      text-transform:none;
      max-width:900px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .vod-cat-list{ flex:1; overflow:auto; padding:14px; }
    .vod-cat-list::-webkit-scrollbar{ width:0; }
    .vod-cat{
      border-radius:16px;
      border:1px solid rgba(0,210,255,.12);
      background: rgba(0,0,0,.24);
      padding:16px;
      margin-bottom:12px;
      transition:.12s;
      font-weight:900;
      font-size:26px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .vod-cat.focused{
      border:4px solid rgba(0,210,255,1);
      box-shadow:0 0 35px rgba(0,210,255,1);
      background: rgba(0,69,255,.22);
      transform:scale(1.02);
    }
    .vod-cat .count{
      color:rgba(255,255,255,.55);
      font-size:18px;
      font-weight:900;
    }

    .vod-grid-wrap{
      flex:1;
      overflow:auto;
      padding:16px;
    }
    .vod-grid-wrap::-webkit-scrollbar{ width:0; }
    .vod-grid{
      display:flex;
      flex-wrap:wrap;
      gap:18px;
    }
    .vod-tile{
      width: 360px;
      height: 210px;
      border-radius:18px;
      overflow:hidden;
      position:relative;
      border:1px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.35);
      transition:.12s;
    }
    .vod-tile img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      background:#000;
    }
    .vod-tile .cap{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:12px 12px;
      font-size:18px;
      font-weight:900;
      background: linear-gradient(to top, rgba(0,0,0,.92), rgba(0,0,0,0));
      text-shadow:0 2px 10px rgba(0,0,0,.75);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      letter-spacing:.3px;
    }
    .vod-tile.focused{
      border:4px solid rgba(0,210,255,1);
      box-shadow:0 0 35px rgba(0,210,255,1);
      transform:scale(1.08);
      z-index:2;
    }

    #vod-debug{
      margin-left:auto;
      padding:8px 12px;
      border-radius:14px;
      border:1px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.70);
      font-size:14px;
      font-weight:900;
      letter-spacing:.2px;
      max-width:760px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-transform:none;
    }

    /* -----------------------------
       SPORT VIEW (placeholder)
    ----------------------------- */
    .sport-root{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:18px;
      padding:22px;
    }
    .sport-tabs{
      display:flex;
      gap:14px;
      padding:10px;
      border-radius:22px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(0,210,255,.16);
    }
    .sport-tab{
      padding:14px 24px;
      font-size:22px;
      font-weight:900;
      color:rgba(255,255,255,.45);
      border-radius:16px;
      transition:.12s;
      background: rgba(0,0,0,.15);
      border:1px solid rgba(0,210,255,.10);
      user-select:none;
    }
    .sport-tab.focused{
      color:#fff;
      background: var(--blue);
      border-color: rgba(255,255,255,.15);
      box-shadow:0 0 18px rgba(0,69,255,.45);
      transform:scale(1.02);
    }
    .sport-body{
      flex:1;
      border-radius:26px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(0,210,255,.14);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .sport-head{
      padding:18px 20px;
      color:var(--cyan);
      font-weight:900;
      letter-spacing:3px;
      font-size:14px;
      text-transform:uppercase;
      border-bottom:1px solid rgba(0,210,255,.10);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .sport-content{
      flex:1;
      padding:18px;
      overflow:auto;
    }
    .sport-content::-webkit-scrollbar{ width:0; }

    /* -----------------------------
       SETUP VIEW (deins + 2 Spalten M3U/XC mit Buttons)
    ----------------------------- */
    #setup-view{
      display:flex;
      flex-direction:column;
      gap:22px;
      padding:22px;
    }

    .tabs{
      display:flex; gap:14px;
      padding:10px;
      border-radius:22px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(0,210,255,.16);
    }
    .tab{
      padding:14px 24px;
      font-size:22px;
      font-weight:900;
      color:rgba(255,255,255,.45);
      border-radius:16px;
      transition:.12s;
      background: rgba(0,0,0,.15);
      border:1px solid rgba(0,210,255,.10);
      user-select:none;
    }
    .tab.focused{
      color:#fff;
      background: var(--blue);
      border-color: rgba(255,255,255,.15);
      box-shadow:0 0 18px rgba(0,69,255,.45);
      transform:scale(1.02);
    }

    .content-col{
      flex:1;
      background: var(--glass2);
      border:1px solid rgba(0,210,255,.14);
      border-radius:26px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .content-header{
      padding:18px 20px;
      color:var(--cyan);
      font-weight:900;
      letter-spacing:3px;
      font-size:14px;
      text-transform:uppercase;
      border-bottom:1px solid rgba(0,210,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .content-body{
      flex:1;
      overflow-y:auto;
      padding:16px;
    }
    .content-body::-webkit-scrollbar{ width:0; }

    .hint{
      color:rgba(255,255,255,.60);
      font-size:18px;
      line-height:1.35;
      letter-spacing:.2px;
      margin-left:auto;
      font-weight:700;
      text-transform:none;
    }

    .card2{
      border-radius:18px;
      border:1px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.22);
      padding:16px;
      margin-bottom:14px;
      transition:.12s;
      color:rgba(255,255,255,.92);
    }
    .card2.focused{
      border:4px solid rgba(0,210,255,1);
      box-shadow:0 0 35px rgba(0,210,255,1);
      transform: scale(1.02);
      background: rgba(0,69,255,.22);
    }
    .card2-title{ font-weight:900; font-size:30px; }
    .card2-sub{ margin-top:10px; color:rgba(255,255,255,.65); font-size:24px; word-break:break-all; }

    .badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      background: rgba(0,210,255,.12);
      border:1px solid rgba(0,210,255,.22);
      color: rgba(255,255,255,.90);
      font-weight:900;
      font-size:16px;
      margin-left:10px;
      vertical-align:middle;
    }
    .badge.active{ background: rgba(0,69,255,.30); border-color: rgba(0,69,255,.55); }

    .label2{ color:var(--cyan); font-weight:900; letter-spacing:2px; font-size:14px; margin-top:10px; text-transform:uppercase; }

    .input{
      width:100%;
      padding:18px 16px;
      margin-top:10px;
      border-radius:14px;
      border:2px solid rgba(0,210,255,.22);
      background: rgba(0,0,0,.28);
      color:#fff;
      font-size:24px;
    }
    .input.focused{
      border:4px solid rgba(0,210,255,1);
      box-shadow:0 0 35px rgba(0,210,255,1);
      background: rgba(0,69,255,.18);
    }

    .btnrow{ display:flex; gap:12px; margin-top:14px; }
    .btn{
      flex:1;
      padding:16px 14px;
      text-align:center;
      border-radius:14px;
      border:2px solid rgba(0,210,255,.22);
      background: rgba(0,69,255,.20);
      font-weight:900;
      font-size:22px;
      transition:.12s;
      color:#fff;
      user-select:none;
    }
    .btn.focused{
      border:4px solid rgba(0,210,255,1);
      box-shadow:0 0 35px rgba(0,210,255,1);
      background: linear-gradient(180deg, rgba(0,210,255,.45), rgba(0,69,255,.95));
      transform:scale(1.03);
    }
    .btn.danger{
      border-color: rgba(255,77,77,.35);
      background: rgba(255,77,77,.10);
    }
    .btn.danger.focused{
      border:4px solid rgba(255,77,77,1);
      box-shadow:0 0 30px rgba(255,77,77,1);
      background: rgba(255,77,77,.35);
    }

    .divider{ height:1px; background: rgba(0,210,255,.18); margin:16px 0; }

    /* Setup: 2 Spalten */
    .setup-split{ display:flex; gap:16px; align-items:stretch; }
    .setup-left{
      width:860px; min-width:860px;
      border-radius:18px;
      border:1px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.18);
      padding:14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .setup-right{
      flex:1;
      border-radius:18px;
      border:1px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.18);
      padding:14px;
      overflow:hidden;
    }
    .setup-left .list{ padding:8px; }

    .profile-row{
      border-radius:16px;
      border:1px solid rgba(0,210,255,.12);
      background: rgba(0,0,0,.22);
      padding:14px;
      margin-bottom:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      transition:.12s;
    }
    .profile-row.focused{
      border:4px solid rgba(0,210,255,1);
      box-shadow:0 0 35px rgba(0,210,255,1);
      background: rgba(0,69,255,.22);
      transform:scale(1.01);
    }
    .prow-top{ display:flex; align-items:center; gap:10px; }
    .prow-name{
      font-weight:900; font-size:28px; flex:1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .prow-sub{ color:rgba(255,255,255,.62); font-size:18px; font-weight:800; word-break:break-all; }
    .prow-actions{ display:flex; gap:12px; }

    /* Background tiles */
    .tile-wrap{ display:flex; flex-wrap:wrap; gap:14px; }
    .tile{
      flex: 0 0 calc((100% - 14px*4) / 5);
      border-radius:18px;
      border:1px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.28);
      overflow:hidden;
      position:relative;
      transition:.12s;
    }
    .tile::before{ content:""; display:block; padding-top:56.25%; }
    .tile.focused{
      border:4px solid rgba(0,210,255,1);
      box-shadow:0 0 35px rgba(0,210,255,1);
      transform: scale(1.05);
    }
    .tile img{
      position:absolute; top:0; left:0; right:0; bottom:0;
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      background:#000;
    }
    .tile .label{
      position:absolute; left:0; right:0; bottom:0;
      padding:10px 10px;
      font-size:16px;
      font-weight:900;
      background: linear-gradient(to top, rgba(0,0,0,.92), rgba(0,0,0,0));
      text-shadow:0 2px 10px rgba(0,0,0,.75);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      color:#fff;
      letter-spacing:.5px;
    }

    /* -----------------------------
       VIRTUAL KEYBOARD (wie vorher: sichtbar + Handy-Style)
    ----------------------------- */
    #vk-overlay{
      position:fixed;
      left:0; top:0;
      width:1920px; height:1080px;
      z-index:20000;
      background: rgba(0,0,0,.68);
      opacity:0;
      visibility:hidden;
      transition: opacity .12s ease-out, visibility .12s ease-out;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:34px 40px;
    }
    #vk-overlay.active{ opacity:1; visibility:visible; }
    #vk-box{
      width: 1760px;
      border-radius:30px;
      background: rgba(0,0,0,.58);
      border: 2px solid rgba(0,210,255,.26);
      box-shadow: 0 0 40px rgba(0,210,255,.10);
      overflow:hidden;
    }
    #vk-preview{
      padding:18px 22px;
      font-size:34px;
      font-weight:900;
      letter-spacing:.4px;
      color:#fff;
      background: rgba(0,0,0,.35);
      border-bottom:1px solid rgba(0,210,255,.16);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #vk-targethint{
      padding:10px 22px 0 22px;
      color: rgba(255,255,255,.65);
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
    }
    #vk-rows{
      padding:16px 18px 14px 18px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .vk-row{ display:flex; gap:10px; justify-content:center; }
    .vk-key{
      height:78px;
      min-width:88px;
      padding:0 18px;
      border-radius:22px;
      border:2px solid rgba(0,210,255,.14);
      background: rgba(0,0,0,.38);
      color: rgba(255,255,255,.92);
      font-weight:900;
      font-size:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:.10s;
      user-select:none;
    }
    .vk-key.wide{ min-width:170px; }
    .vk-key.xwide{ min-width:520px; }
    .vk-key.xxwide{ min-width:320px; }
    .vk-key.danger{
      border-color: rgba(255,77,77,.35);
      background: rgba(255,77,77,.10);
    }
    .vk-key.primary{
      border-color: rgba(0,210,255,.28);
      background: rgba(0,69,255,.18);
    }
    .vk-key.focused{
      border:4px solid rgba(0,210,255,1);
      box-shadow:0 0 35px rgba(0,210,255,1);
      background: linear-gradient(180deg, rgba(0,210,255,.45), rgba(0,69,255,.95));
      color:#fff;
      transform: scale(1.08);
    }
    #vk-hint{
      padding:14px 22px;
      border-top:1px solid rgba(0,210,255,.14);
      color: rgba(255,255,255,.65);
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      justify-content:space-between;
      gap:12px;
    }

    /* -----------------------------
       TV Profile Dropup (Dropup)
    ----------------------------- */
    #tv-prof-overlay{
      position:fixed;
      left:0; top:0;
      width:1920px; height:1080px;
      z-index:18000;
      background: rgba(0,0,0,.35);
      opacity:0;
      visibility:hidden;
      transition: opacity .12s ease-out, visibility .12s ease-out;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:30px 60px;
    }
    #tv-prof-overlay.active{ opacity:1; visibility:visible; }
    #tv-prof-box{
      width: 980px;
      max-height: 680px;
      border-radius:26px;
      background: rgba(0,0,0,.62);
      border:2px solid rgba(0,210,255,.28);
      box-shadow:0 0 40px rgba(0,210,255,.14);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    #tv-prof-head{
      padding:18px 20px;
      color:var(--cyan);
      font-weight:900;
      letter-spacing:3px;
      font-size:14px;
      text-transform:uppercase;
      border-bottom:1px solid rgba(0,210,255,.16);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    #tv-prof-list{
      flex:1;
      overflow:auto;
      padding:16px;
    }
    #tv-prof-list::-webkit-scrollbar{ width:0; }
    .tvprof-item{
      border-radius:16px;
      border:1px solid rgba(0,210,255,.12);
      background: rgba(0,0,0,.22);
      padding:16px;
      margin-bottom:12px;
      font-weight:900;
      font-size:26px;
      display:flex;
      align-items:center;
      gap:10px;
      transition:.12s;
    }
    .tvprof-item.focused{
      border:4px solid rgba(0,210,255,1);
      box-shadow:0 0 35px rgba(0,210,255,1);
      background: rgba(0,69,255,.22);
      transform:scale(1.02);
    }
    .tvprof-sub{
      margin-left:auto;
      color:rgba(255,255,255,.65);
      font-size:18px;
      font-weight:800;
    }
  </style>
</head>

<body onload="init()">
  <header>
    <div class="brand">BLACK<span>IPTV</span></div>

    <nav id="menu">
      <div id="m0" class="menu-item">TV</div>
      <div id="m1" class="menu-item">FILME</div>
      <div id="m2" class="menu-item">SERIEN</div>
      <div id="m3" class="menu-item">SPORT</div>
      <div id="m4" class="menu-item">EINSTELLUNG</div>
    </nav>

    <div class="header-right">
      <div id="clock">--:--</div>
      <div id="date">---</div>
    </div>
  </header>

  <main>
    <div class="panel">

      <!-- TV -->
      <div id="tv-view">
        <div class="tv-root">
          <div class="col" id="tv-left" style="width:420px">
            <div class="col-h">
              <span>Kategorien</span>
              <span id="tv-cat-count" style="color:rgba(255,255,255,.5);font-weight:900;font-size:14px"></span>
            </div>
            <div id="tv-cat-list" class="list"></div>
          </div>

          <div class="col" id="tv-mid" style="width:620px">
            <div class="col-h">
              <span>Sender</span>
              <span id="tv-chan-count" style="color:rgba(255,255,255,.5);font-weight:900;font-size:14px"></span>
            </div>
            <div id="tv-chan-list" class="list"></div>
          </div>

          <div class="col" style="flex:1">
            <div class="col-h">
              <span>Player</span>
              <span style="color:rgba(255,255,255,.55);font-weight:900;font-size:14px">
                OK=Play • 0=Fav • Back=Menu • OK(2x)=Fullscreen • OK(2s)=Profil
              </span>
            </div>
            <div class="player">
              <div class="video-box" id="tv-video-box">
                <object id="av-player" type="application/avplayer" style="width:100%;height:100%;display:none;"></object>
                <video id="tv-video" autoplay style="width:100%;height:100%;object-fit:contain;display:none;"></video>
              </div>
              <div class="pinfo">
                <div class="pname" id="tv-now">-</div>
                <div class="phint" id="tv-msg">Wähle ein M3U Profil in EINSTELLUNG → M3U PROFILE</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- VOD (Netflix Style) -->
      <div id="vod-view">
        <div class="vod-netflix">
          <div class="vod-left">
            <div class="vod-head">
              <span id="vod-left-title">KATEGORIEN</span>
              <span class="vod-status" id="vod-left-sub">-</span>
            </div>
            <div id="vod-cat-list" class="vod-cat-list"></div>
          </div>

          <div class="vod-right">
            <div class="vod-head">
              <span id="vod-right-title">INHALTE</span>
              <span id="vod-debug">-</span>
            </div>
            <div id="vod-grid-wrap" class="vod-grid-wrap">
              <div id="vod-grid" class="vod-grid"></div>
            </div>
          </div>
        </div>

        <!-- (ALT) Elemente bleiben drin, werden aber nicht genutzt -->
        <div style="display:none">
          <div id="vod-rows"></div>
          <video id="vod-video" autoplay></video>
          <div id="vod-info-title"></div>
          <div id="vod-info-sub"></div>
          <div id="vod-sub"></div>
          <div id="vod-title"></div>
          <div id="vod-hint"></div>
        </div>
      </div>

      <!-- SPORT -->
      <div id="sport-view">
        <div class="sport-root">
          <div class="sport-tabs">
            <div id="s0" class="sport-tab">SPORT</div>
            <div id="s1" class="sport-tab">LIVE SCORE</div>
          </div>
          <div class="sport-body">
            <div class="sport-head">
              <span id="sport-title">SPORT</span>
              <span style="color:rgba(255,255,255,.55);font-weight:900;font-size:14px">←/→ Tabs • Back=Menu</span>
            </div>
            <div id="sport-content" class="sport-content"></div>
          </div>
        </div>
      </div>

      <!-- SETUP -->
      <div id="setup-view">
        <div class="tabs">
          <div id="t0" class="tab">HINTERGRUND</div>
          <div id="t1" class="tab">M3U PROFILE</div>
          <div id="t2" class="tab">XTREAM PROFILE</div>
          <div id="t3" class="tab">MAC ADRESSE</div>
        </div>

        <div class="content-col">
          <div class="content-header">
            <span id="content-title">HINTERGRUND</span>
            <span id="content-hint" class="hint">Tabs: ←/→ • OK = rein • Zurück = Menü</span>
          </div>
          <div id="content-body" class="content-body"></div>
        </div>
      </div>

    </div>
  </main>

  <!-- VIRTUAL KEYBOARD -->
  <div id="vk-overlay">
    <div id="vk-box">
      <div id="vk-preview">-</div>
      <div id="vk-targethint">-</div>
      <div id="vk-rows"></div>
      <div id="vk-hint">
        <span>▲▼◀▶ bewegen • OK = Eingabe • 0 = Leertaste</span>
        <span>BACK = Schließen • DONE = Übernehmen</span>
      </div>
    </div>
  </div>

  <!-- TV Profile Dropup -->
  <div id="tv-prof-overlay">
    <div id="tv-prof-box">
      <div id="tv-prof-head">
        <span>M3U PROFILE</span>
        <span style="color:rgba(255,255,255,.55);font-weight:900;font-size:14px">▲/▼ • OK=Aktivieren • Back=Schließen</span>
      </div>
      <div id="tv-prof-list"></div>
    </div>
  </div>

<script>
  // -----------------------------
  // Helpers
  // -----------------------------
  function $(id){ return document.getElementById(id); }
  function esc(s){
    return String(s||"")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }
  function nowBust(){ return "t=" + Date.now(); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function uuid(){ return "id_" + Date.now() + "_" + Math.floor(Math.random()*100000); }

  // -----------------------------
  // Clock / Date (oben rechts)
  // -----------------------------
  function pad2(n){ return (n<10?"0":"")+n; }
  function tickClock(){
    var d=new Date();
    var hh=pad2(d.getHours());
    var mm=pad2(d.getMinutes());
    $("clock").innerText = hh+":"+mm;
    var days=["So","Mo","Di","Mi","Do","Fr","Sa"];
    var months=["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
    $("date").innerText = days[d.getDay()]+" • "+pad2(d.getDate())+" "+months[d.getMonth()]+" "+d.getFullYear();
  }

  // -----------------------------
  // Player (Samsung Tizen AVPlay + fallback)
  // -----------------------------
  var tvUseAvplay = false;
  var av = null;
  var tvLastUrl = "";
  var tvHls = null;
  var tvFullscreen = false;

  function initPlayer(){
    tvUseAvplay = !!(window.webapis && webapis.avplay);
    if(tvUseAvplay){
      av = webapis.avplay;
      try{ $("av-player").style.display="block"; }catch(e){}
      try{ $("tv-video").style.display="none"; }catch(e){}
      try{
        av.setListener({
          onbufferingstart: function(){},
          onbufferingprogress: function(){},
          onbufferingcomplete: function(){},
          oncurrentplaytime: function(){},
          onevent: function(){},
          onerror: function(){},
          onstreamcompleted: function(){ try{ av.stop(); }catch(e){} }
        });
      }catch(e){}
    }else{
      try{ $("tv-video").style.display="block"; }catch(e){}
      try{ $("av-player").style.display="none"; }catch(e){}
    }
  }

  function applyPlayerRect(full){
    var x=0,y=0,w=1920,h=1080;
    if(!full){
      var box=$("tv-video-box");
      if(box){
        var r=box.getBoundingClientRect();
        x=Math.round(r.left);
        y=Math.round(r.top);
        w=Math.round(r.width);
        h=Math.round(r.height);
      }
    }
    try{
      if(window.tizen && tizen.tvwindow){
        tizen.tvwindow.show(function(){}, function(){});
        tizen.tvwindow.setRect(x,y,w,h);
      }
    }catch(e){}
    if(av){
      try{ av.setDisplayRect(x,y,w,h); }catch(e){}
      try{ av.setDisplayMethod(full ? "PLAYER_DISPLAY_MODE_FULL_SCREEN" : "PLAYER_DISPLAY_MODE_AUTO"); }catch(e){}
    }
  }

  function playUrl(url){
    if(!url) return;
    tvLastUrl = url;

    if(tvUseAvplay && av){
      try{ av.stop(); }catch(e){}
      try{ av.close(); }catch(e){}
      try{
        av.open(url);
        av.setStreamingProperty && av.setStreamingProperty("ADAPTIVE_INFO", "BITRATE=5000");
        av.prepareAsync(function(){
          applyPlayerRect(tvFullscreen);
          try{ av.play(); }catch(e){}
        }, function(){
          try{ av.play(); }catch(e){}
        });
      }catch(e){}
      return;
    }

    var v=$("tv-video");
    if(!v) return;

    if(tvHls){ try{ tvHls.destroy(); }catch(e){} tvHls=null; }
    try{ v.pause(); v.removeAttribute("src"); v.load(); }catch(e){}

    if(window.Hls && Hls.isSupported()){
      tvHls = new Hls({enableWorker:true, lowLatencyMode:true, backBufferLength:30});
      tvHls.loadSource(url);
      tvHls.attachMedia(v);
      tvHls.on(Hls.Events.MANIFEST_PARSED, function(){ v.play().catch(function(){}); });
    }else{
      v.src=url;
      v.play().catch(function(){});
    }
  }

  function tvToggleFullscreen(){
    tvFullscreen = !tvFullscreen;
    document.body.classList.toggle("is-fullscreen", tvFullscreen);
    applyPlayerRect(tvFullscreen);
  }

  // -----------------------------
  // App Globals
  // -----------------------------
  var GH_OWNER = "Artonstyle";
  var GH_REPO  = "IPTVBlack";
  var GH_BG_DIR = "hintergrund";

  var area = "menu"; // menu | tvCats | tvChans | tabs | setupContent | vodCats | vodGrid | sportTabs | keyboard | tvProf
  var menuIdx = 0;

  var tabIdx = 0;
  var setupFocusIdx = 0;

  var sportTabIdx = 0;

  var bgItems = [];

  var m3uProfiles = JSON.parse(localStorage.getItem("iptv_m3u_profiles") || "[]");
  var xcProfiles  = JSON.parse(localStorage.getItem("iptv_xc_profiles")  || "[]");
  var activeM3UId = localStorage.getItem("iptv_active_m3u_id") || "";
  var activeXCId  = localStorage.getItem("iptv_active_xc_id")  || "";

  var m3uEditIdx = -1;
  var xcEditIdx  = -1;

  // TV data
  var tvCats = [];
  var tvAllChans = [];
  var tvCurChans = [];
  var tvTotalCount = 0;
  var tvCatIdx = 0;
  var tvChanIdx = 0;
  var tvFavs = JSON.parse(localStorage.getItem("iptv_tv_favs") || "[]");

  // VOD Netflix data
  var vodMode = "movies"; // movies | series
  var vodCats = [];
  var vodCatIdx = 0;
  var vodItems = [];
  var vodItemIdx = 0;
  var vodGridCols = 4; // recalculated on render
  var vodTotalAll = 0;

  function normalizeProfiles(){
    if(!Array.isArray(m3uProfiles)) m3uProfiles=[];
    if(!Array.isArray(xcProfiles))  xcProfiles=[];
    localStorage.setItem("iptv_m3u_profiles", JSON.stringify(m3uProfiles));
    localStorage.setItem("iptv_xc_profiles",  JSON.stringify(xcProfiles));
  }

  function showMain(which){
    $("tv-view").style.display    = (which==="tv")    ? "block" : "none";
    $("vod-view").style.display   = (which==="vod")   ? "block" : "none";
    $("sport-view").style.display = (which==="sport") ? "block" : "none";
    $("setup-view").style.display = (which==="setup") ? "flex"  : "none";
  }
  function showMainByMenu(idx){
    if(idx===0){
      showMain("tv");
    }else if(idx===1){
      showMain("vod");
      vodMode="movies";
    }else if(idx===2){
      showMain("vod");
      vodMode="series";
    }else if(idx===3){
      showMain("sport");
    }else{
      showMain("setup");
    }
  }

  function renderMenuFocus(){
    for(var i=0;i<5;i++){
      $("m"+i).classList.toggle("focused", area==="menu" && i===menuIdx);
    }
  }

  // -----------------------------
  // Robust Xtream fetch (zeigt IMMER was)
  // -----------------------------
  function vodSetDebug(t){
    $("vod-debug").innerText = (t||"-");
  }
  function vodSetStatusLeft(t){
    $("vod-left-sub").innerText = (t||"-");
  }

  function xtFetchJSON(url, ok, fail){
    try{
      vodSetDebug("GET: "+url);
    }catch(e){}

    var xhr=new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.timeout=30000;
    xhr.onreadystatechange=function(){
      if(xhr.readyState!==4) return;
      if(xhr.status===200 && xhr.responseText){
        try{
          var j=JSON.parse(xhr.responseText);
          ok(j, xhr);
        }catch(e){
          fail("JSON Parse Fehler", xhr);
        }
      }else{
        fail("HTTP Fehler "+xhr.status, xhr);
      }
    };
    xhr.ontimeout=function(){ fail("Timeout", xhr); };
    xhr.onerror=function(){ fail("Netzwerk/CORS Fehler", xhr); };
    try{ xhr.send(); }catch(e){ fail("Send Fehler", xhr); }
  }

  function xtreamApi(xc, action){
    return xc.url + "/player_api.php?username=" + encodeURIComponent(xc.user) + "&password=" + encodeURIComponent(xc.pass) + (action?("&action=" + encodeURIComponent(action)):"");
  }

  function getActiveXC(){
    for(var i=0;i<xcProfiles.length;i++){
      if(xcProfiles[i].id===activeXCId) return xcProfiles[i];
    }
    return null;
  }

  function vodReloadNetflix(){
    vodCats=[]; vodItems=[];
    vodCatIdx=0; vodItemIdx=0;
    vodTotalAll=0;

    $("vod-left-title").innerText = (vodMode==="movies" ? "FILME – KATEGORIEN" : "SERIEN – KATEGORIEN");
    $("vod-right-title").innerText = (vodMode==="movies" ? "FILME" : "SERIEN");
    vodSetStatusLeft("Prüfe Xtream Profil…");
    vodSetDebug("-");

    var xc=getActiveXC();
    if(!xc){
      $("vod-cat-list").innerHTML = '<div style="padding:18px;color:rgba(255,255,255,.75);font-weight:900;font-size:22px">Kein aktives Xtream Profil (Einstellung → Xtream)</div>';
      $("vod-grid").innerHTML = "";
      return;
    }

    // Login check -> damit du SIEHST, ob überhaupt eine Antwort kommt
    vodSetStatusLeft("Login Test: "+xc.name+" …");
    xtFetchJSON(xtreamApi(xc, ""), function(j){
      var st = (j && j.user_info && j.user_info.status) ? j.user_info.status : "OK";
      vodSetStatusLeft("Login: "+st+" • Lade Kategorien…");
      vodLoadCats(xc);
    }, function(msg){
      vodSetStatusLeft("Login FEHLER: "+msg);
      $("vod-cat-list").innerHTML = '<div style="padding:18px;color:rgba(255,255,255,.75);font-weight:900;font-size:22px">Xtream Fehler: '+esc(msg)+'</div>';
      $("vod-grid").innerHTML = "";
    });
  }

  function vodLoadCats(xc){
    var action = (vodMode==="movies") ? "get_vod_categories" : "get_series_categories";
    xtFetchJSON(xtreamApi(xc, action), function(cats){
      if(!Array.isArray(cats)) cats=[];
      vodCats = cats.slice(0, 60); // mehr Kategorien möglich
      if(!vodCats.length){
        vodSetStatusLeft("Keine Kategorien gefunden");
        $("vod-cat-list").innerHTML = '<div style="padding:18px;color:rgba(255,255,255,.75);font-weight:900;font-size:22px">Keine Kategorien</div>';
        return;
      }
      vodCatIdx = 0;
      renderVodCats();
      vodLoadItemsForCurrentCat(true);
    }, function(msg){
      vodSetStatusLeft("Kategorien FEHLER: "+msg);
      $("vod-cat-list").innerHTML = '<div style="padding:18px;color:rgba(255,255,255,.75);font-weight:900;font-size:22px">Kategorien Fehler: '+esc(msg)+'</div>';
      $("vod-grid").innerHTML = "";
    });
  }

  function renderVodCats(){
    var html="";
    for(var i=0;i<vodCats.length;i++){
      var c=vodCats[i];
      var name = c.category_name || c.name || ("Kategorie "+(i+1));
      html += '<div class="vod-cat'+(area==="vodCats" && i===vodCatIdx?' focused':'')+'" data-idx="'+i+'">'+
                '<span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+esc(name)+'</span>'+
                '<span class="count">ID '+esc(c.category_id||"")+'</span>'+
              '</div>';
    }
    $("vod-cat-list").innerHTML = html;
    try{
      var el=$("vod-cat-list").querySelector('.vod-cat[data-idx="'+vodCatIdx+'"]');
      if(el) el.scrollIntoView({block:"center"});
    }catch(e){}
  }

  function vodLoadItemsForCurrentCat(scrollTop){
    var xc=getActiveXC();
    if(!xc) return;
    var cat = vodCats[vodCatIdx];
    if(!cat) return;

    var listAction = (vodMode==="movies") ? "get_vod_streams" : "get_series";
    var url = xtreamApi(xc, listAction) + "&category_id=" + encodeURIComponent(cat.category_id||"");

    vodSetStatusLeft("Lade: "+(cat.category_name||cat.name||"Kategorie")+" …");
    vodSetDebug("Lade Inhalte…");

    xtFetchJSON(url, function(items){
      if(!Array.isArray(items)) items=[];
      // hier laden wir mehr, aber UI zeigt z.B. 120 an (sonst wird es riesig)
      vodTotalAll = items.length;

      // Für schnelle UI: max 120 Kacheln (kannst du erhöhen)
      var show = items.slice(0, 120);
      vodItems = show.map(function(it){
        return {
          name: it.name || "Unbekannt",
          poster: (it.stream_icon || it.cover || ""),
          meta: (vodMode==="movies" ? ("Movie • ID "+(it.stream_id||"")) : ("Serie • ID "+(it.series_id||"")))
        };
      });

      vodItemIdx = 0;
      renderVodGrid();
      vodSetStatusLeft("Kategorie: "+(cat.category_name||cat.name||"")+" • Gesamt: "+vodTotalAll+" • Anzeige: "+vodItems.length);
      vodSetDebug("OK • Streams: "+vodTotalAll);

      if(scrollTop){
        try{ $("vod-grid-wrap").scrollTop = 0; }catch(e){}
      }
      updateFocus();
    }, function(msg){
      vodSetStatusLeft("Inhalte FEHLER: "+msg);
      vodSetDebug(msg);
      $("vod-grid").innerHTML = '<div style="padding:18px;color:rgba(255,255,255,.75);font-weight:900;font-size:22px">Fehler: '+esc(msg)+'</div>';
    });
  }

  function renderVodGrid(){
    // rechne cols nach Breite (für Navigation)
    vodGridCols = 4;

    var html="";
    if(!vodItems.length){
      html = '<div style="padding:18px;color:rgba(255,255,255,.75);font-weight:900;font-size:22px">Keine Inhalte</div>';
      $("vod-grid").innerHTML = html;
      return;
    }

    for(var i=0;i<vodItems.length;i++){
      var it=vodItems[i];
      var poster = it.poster ? (it.poster + (it.poster.indexOf("?")>-1 ? "&" : "?") + nowBust()) : "";
      html += '<div class="vod-tile'+(area==="vodGrid" && i===vodItemIdx?' focused':'')+'" data-idx="'+i+'">'+
                (poster
                  ? '<img src="'+poster+'" onerror="this.src=\'\';this.style.background=\'#000\';" />'
                  : '<div style="width:100%;height:100%;background:#000"></div>'
                )+
                '<div class="cap">'+esc(it.name)+'</div>'+
              '</div>';
    }
    $("vod-grid").innerHTML = html;

    try{
      var el=$("vod-grid").querySelector('.vod-tile[data-idx="'+vodItemIdx+'"]');
      if(el) el.scrollIntoView({block:"nearest", inline:"nearest"});
    }catch(e){}
  }

  // -----------------------------
  // Backgrounds
  // -----------------------------
  function loadBackgroundsFromGitHub(){
    var url="https://api.github.com/repos/"+encodeURIComponent(GH_OWNER)+"/"+encodeURIComponent(GH_REPO)+"/contents/"+encodeURIComponent(GH_BG_DIR)+"?"+nowBust();
    fetch(url)
      .then(function(r){ return r.json(); })
      .then(function(arr){
        var list=[];
        if(Array.isArray(arr)){
          for(var i=0;i<arr.length;i++){
            var it=arr[i];
            if(!it || it.type!=="file") continue;
            var n=(it.name||"").toLowerCase();
            if(!(n.endsWith(".jpg")||n.endsWith(".jpeg")||n.endsWith(".png")||n.endsWith(".webp"))) continue;
            var dl = it.download_url || ("https://raw.githubusercontent.com/"+GH_OWNER+"/"+GH_REPO+"/main/"+GH_BG_DIR+"/"+it.name);
            list.push({ name: it.name, url: dl });
          }
        }
        list.sort(function(a,b){ return a.name.localeCompare(b.name); });
        bgItems=list;
        if(menuIdx===4) renderSetupTabPreview();
      })
      .catch(function(){
        bgItems=[];
        if(menuIdx===4) renderSetupTabPreview();
      });
  }

  function setBackground(url){
    if(!url){
      document.body.style.backgroundImage="";
      document.body.style.background="radial-gradient(circle at top right, #001a4d, #00050a)";
      return;
    }
    document.body.style.backgroundImage =
      "linear-gradient(rgba(0,0,0,.45), rgba(0,0,0,.55)), url('"+url+"?"+nowBust()+"')";
    document.body.style.backgroundSize="cover";
    document.body.style.backgroundPosition="center";
  }

  // -----------------------------
  // Setup Tabs + Title
  // -----------------------------
  function renderSetupTabs(){
    for(var i=0;i<4;i++){
      $("t"+i).classList.toggle("focused", area==="tabs" && i===tabIdx);
    }
  }

  function setSetupTitle(){
    var titles=["HINTERGRUND","M3U PROFILE","XTREAM PROFILE","MAC ADRESSE"];
    $("content-title").innerText = titles[tabIdx];

    if(area==="setupContent"){
      if(tabIdx===0) $("content-hint").innerText = "OK = Hintergrund setzen • 0 = Standard • Zurück = Tabs";
      else if(tabIdx===1) $("content-hint").innerText = "Buttons: Aktivieren/Bearbeiten/Löschen • OK = Aktion • Zurück = Tabs";
      else if(tabIdx===2) $("content-hint").innerText = "Buttons: Aktivieren/Bearbeiten/Löschen • OK = Aktion • Zurück = Tabs";
      else $("content-hint").innerText = "OK = Aktualisieren • Zurück = Tabs";
    }else{
      $("content-hint").innerText = "Tabs: ←/→ • OK = rein • Zurück = Menü";
    }
  }

  function renderSetupTabPreview(){
    setSetupTitle();
    setupFocusIdx=0;

    if(tabIdx===0) renderBGTab();
    else if(tabIdx===1) renderM3UTab();
    else if(tabIdx===2) renderXCTab();
    else renderMACTab();

    updateFocus();
  }

  function getSetupFocusables(){
    return $("content-body").querySelectorAll(".focusable");
  }

  function renderBGTab(){
    var host=$("content-body");
    if(!bgItems.length){
      host.innerHTML =
        '<div class="card2">'+
          '<div class="card2-title">Keine Bilder gefunden</div>'+
          '<div class="card2-sub">Ordner: /'+esc(GH_BG_DIR)+'</div>'+
        '</div>';
      return;
    }
    var html='<div class="tile-wrap">';
    for(var i=0;i<bgItems.length;i++){
      html +=
        '<div class="tile focusable" data-kind="bg" data-idx="'+i+'">'+
          '<img src="'+bgItems[i].url+'?'+nowBust()+'" onerror="this.style.opacity=\'0\';" />'+
          '<div class="label">'+esc(bgItems[i].name)+'</div>'+
        '</div>';
    }
    html+='</div>';
    host.innerHTML=html;
  }

  // -----------------------------
  // MAC Adresse (fix: mehrere Tizen Fallbacks)
  // -----------------------------
  function setMacText(v){
    try{
      var el=$("mac-text");
      if(el) el.innerText = v || "unbekannt";
    }catch(e){}
  }

  function tryReadMacAsync(){
    // 1) webapis.network.getMac()
    try{
      if(window.webapis && webapis.network){
        if(typeof webapis.network.getMac==="function"){
          var m = webapis.network.getMac();
          if(m && m!=="00:00:00:00:00:00"){ setMacText(m); return; }
        }
        // manche Modelle haben getMacAddress (je nach SDK)
        if(typeof webapis.network.getMacAddress==="function"){
          var m2 = webapis.network.getMacAddress();
          if(m2 && m2!=="00:00:00:00:00:00"){ setMacText(m2); return; }
        }
      }
    }catch(e){}

    // 2) tizen.systeminfo NETWORK
    try{
      if(window.tizen && tizen.systeminfo && typeof tizen.systeminfo.getPropertyValue==="function"){
        tizen.systeminfo.getPropertyValue("NETWORK", function(n){
          var cand = (n && (n.macAddress || n.mac || n.wiredMacAddress || n.wifiMacAddress)) ? (n.macAddress || n.mac || n.wiredMacAddress || n.wifiMacAddress) : "";
          if(cand){ setMacText(cand); }
          else { setMacText("unbekannt"); }
        }, function(){
          setMacText("unbekannt");
        });
        return;
      }
    }catch(e){}

    setMacText("unbekannt");
  }

  function renderMACTab(){
    $("content-body").innerHTML =
      '<div class="card2 focusable" data-kind="mac" data-idx="0">'+
        '<div class="card2-title">MAC ADRESSE</div>'+
        '<div id="mac-text" class="card2-sub" style="font-size:30px">Lade…</div>'+
        '<div class="card2-sub" style="font-size:20px">OK = Aktualisieren</div>'+
      '</div>';
    // async load
    setTimeout(tryReadMacAsync, 50);
  }

  // -----------------------------
  // Profiles: M3U / Xtream (2 Spalten + Buttons)
  // -----------------------------
  function saveM3UProfiles(){ localStorage.setItem("iptv_m3u_profiles", JSON.stringify(m3uProfiles)); }
  function setActiveM3U(id){ activeM3UId = id || ""; localStorage.setItem("iptv_active_m3u_id", activeM3UId); }
  function getActiveM3U(){
    for(var i=0;i<m3uProfiles.length;i++){
      if(m3uProfiles[i].id===activeM3UId) return m3uProfiles[i];
    }
    return null;
  }

  function addM3UProfile(name,url){
    name=(name||"").trim(); url=(url||"").trim();
    if(!name) name="M3U Profil";
    if(!url) return false;
    var p={ id: uuid(), name:name, url:url };
    m3uProfiles.unshift(p);
    if(m3uProfiles.length>60) m3uProfiles = m3uProfiles.slice(0,60);
    saveM3UProfiles(); setActiveM3U(p.id);
    return true;
  }
  function updateM3UProfile(index, name, url){
    if(index<0 || index>=m3uProfiles.length) return false;
    name=(name||"").trim(); url=(url||"").trim();
    if(!name) name="M3U Profil";
    if(!url) return false;
    m3uProfiles[index].name = name;
    m3uProfiles[index].url = url;
    saveM3UProfiles();
    return true;
  }
  function deleteM3UProfile(index){
    if(index<0 || index>=m3uProfiles.length) return;
    var id = m3uProfiles[index].id;
    m3uProfiles.splice(index,1);
    saveM3UProfiles();
    if(activeM3UId===id) setActiveM3U(m3uProfiles[0] ? m3uProfiles[0].id : "");
  }

  function saveXCProfiles(){ localStorage.setItem("iptv_xc_profiles", JSON.stringify(xcProfiles)); }
  function setActiveXC(id){ activeXCId = id || ""; localStorage.setItem("iptv_active_xc_id", activeXCId); }

  function addXCProfile(name,user,pass,url){
    name=(name||"").trim(); user=(user||"").trim(); pass=(pass||"").trim(); url=(url||"").trim();
    if(!name) name="Xtream Profil";
    if(!user || !pass || !url) return false;
    url = url.replace(/\/+$/,"");
    if(url.indexOf("http://")!==0 && url.indexOf("https://")!==0) url="http://"+url;
    var p={ id: uuid(), name:name, user:user, pass:pass, url:url };
    xcProfiles.unshift(p);
    if(xcProfiles.length>60) xcProfiles = xcProfiles.slice(0,60);
    saveXCProfiles(); setActiveXC(p.id);
    return true;
  }
  function updateXCProfile(index, name, user, pass, url){
    if(index<0 || index>=xcProfiles.length) return false;
    name=(name||"").trim(); user=(user||"").trim(); pass=(pass||"").trim(); url=(url||"").trim();
    if(!name) name="Xtream Profil";
    if(!user || !pass || !url) return false;
    url = url.replace(/\/+$/,"");
    if(url.indexOf("http://")!==0 && url.indexOf("https://")!==0) url="http://"+url;
    xcProfiles[index].name=name; xcProfiles[index].user=user; xcProfiles[index].pass=pass; xcProfiles[index].url=url;
    saveXCProfiles();
    return true;
  }
  function deleteXCProfile(index){
    if(index<0 || index>=xcProfiles.length) return;
    var id = xcProfiles[index].id;
    xcProfiles.splice(index,1);
    saveXCProfiles();
    if(activeXCId===id) setActiveXC(xcProfiles[0] ? xcProfiles[0].id : "");
  }

  function renderM3UTab(){
    var host=$("content-body");
    var html='';
    html += '<div class="setup-split">';
    html +=
      '<div class="setup-left">'+
        '<div class="col-h" style="border-radius:14px;margin-bottom:10px">'+
          '<span>GESPEICHERTE M3U LISTEN</span>'+
          '<span style="color:rgba(255,255,255,.55);font-weight:900;font-size:14px">'+(m3uProfiles.length)+' Profile</span>'+
        '</div>'+
        '<div class="list">';

    if(!m3uProfiles.length){
      html += '<div style="padding:16px;color:rgba(255,255,255,.7);font-weight:900;font-size:22px">Keine Profile</div>';
    }else{
      for(var i=0;i<m3uProfiles.length;i++){
        var p=m3uProfiles[i];
        var isActive = (p.id && p.id===activeM3UId);
        html +=
          '<div class="profile-row focusable" data-kind="m3u-row" data-idx="'+i+'">'+
            '<div class="prow-top">'+
              '<div class="prow-name">'+esc(p.name||("Profil "+(i+1)))+(isActive?'<span class="badge active">AKTIV</span>':'')+'</div>'+
            '</div>'+
            '<div class="prow-sub">'+esc(p.url||"")+'</div>'+
            '<div class="prow-actions">'+
              '<div class="btn focusable" data-kind="m3u-act" data-idx="'+i+'" data-act="activate">Aktivieren</div>'+
              '<div class="btn focusable" data-kind="m3u-act" data-idx="'+i+'" data-act="edit">Bearbeiten</div>'+
              '<div class="btn danger focusable" data-kind="m3u-act" data-idx="'+i+'" data-act="delete">Löschen</div>'+
            '</div>'+
          '</div>';
      }
    }
    html += '</div></div>';

    html +=
      '<div class="setup-right">'+
        '<div class="card2" style="margin-bottom:0">'+
          '<div class="card2-title">'+(m3uEditIdx>-1?'M3U Profil bearbeiten':'Neues M3U Profil')+'</div>'+
          '<div class="label2">NAME</div>'+
          '<input id="m3u-name" readonly class="input focusable" data-kind="m3u-input" data-idx="0" placeholder="z.B. Zuhause" />'+
          '<div class="label2">M3U URL</div>'+
          '<input id="m3u-url" readonly class="input focusable" data-kind="m3u-input" data-idx="1" placeholder="https://example.com/list.m3u" />'+
          '<div class="btnrow">'+
            '<div id="m3u-save" class="btn focusable" data-kind="m3u-save" data-idx="2">'+(m3uEditIdx>-1?'Aktualisieren':'Speichern')+'</div>'+
            '<div id="m3u-cancel" class="btn danger focusable" data-kind="m3u-cancel" data-idx="3">Abbrechen</div>'+
          '</div>'+
          '<div class="card2-sub" style="font-size:18px;margin-top:12px;">OK auf Feld = Tastatur • OK auf Button = Aktion</div>'+
        '</div>'+
      '</div>';

    html += '</div>';
    host.innerHTML = html;

    if(m3uEditIdx>-1 && m3uProfiles[m3uEditIdx]){
      $("m3u-name").value = m3uProfiles[m3uEditIdx].name || "";
      $("m3u-url").value  = m3uProfiles[m3uEditIdx].url  || "";
    }else{
      $("m3u-name").value = "";
      $("m3u-url").value  = "";
    }
  }

  function renderXCTab(){
    var host=$("content-body");
    var html='';
    html += '<div class="setup-split">';
    html +=
      '<div class="setup-left">'+
        '<div class="col-h" style="border-radius:14px;margin-bottom:10px">'+
          '<span>GESPEICHERTE XTREAM PROFILE</span>'+
          '<span style="color:rgba(255,255,255,.55);font-weight:900;font-size:14px">'+(xcProfiles.length)+' Profile</span>'+
        '</div>'+
        '<div class="list">';

    if(!xcProfiles.length){
      html += '<div style="padding:16px;color:rgba(255,255,255,.7);font-weight:900;font-size:22px">Keine Profile</div>';
    }else{
      for(var i=0;i<xcProfiles.length;i++){
        var p=xcProfiles[i];
        var isActive = (p.id && p.id===activeXCId);
        html +=
          '<div class="profile-row focusable" data-kind="xc-row" data-idx="'+i+'">'+
            '<div class="prow-top">'+
              '<div class="prow-name">'+esc(p.name||("Xtream "+(i+1)))+(isActive?'<span class="badge active">AKTIV</span>':'')+'</div>'+
            '</div>'+
            '<div class="prow-sub">User: '+esc(p.user||"")+'</div>'+
            '<div class="prow-sub">URL: '+esc(p.url||"")+'</div>'+
            '<div class="prow-actions">'+
              '<div class="btn focusable" data-kind="xc-act" data-idx="'+i+'" data-act="activate">Aktivieren</div>'+
              '<div class="btn focusable" data-kind="xc-act" data-idx="'+i+'" data-act="edit">Bearbeiten</div>'+
              '<div class="btn danger focusable" data-kind="xc-act" data-idx="'+i+'" data-act="delete">Löschen</div>'+
            '</div>'+
          '</div>';
      }
    }

    html += '</div></div>';

    html +=
      '<div class="setup-right">'+
        '<div class="card2" style="margin-bottom:0">'+
          '<div class="card2-title">'+(xcEditIdx>-1?'Xtream Profil bearbeiten':'Neues Xtream Profil')+'</div>'+
          '<div class="label2">NAME</div>'+
          '<input id="xc-name" readonly class="input focusable" data-kind="xc-input" data-idx="0" placeholder="z.B. Anbieter A" />'+
          '<div class="label2">BENUTZERNAME</div>'+
          '<input id="xc-user" readonly class="input focusable" data-kind="xc-input" data-idx="1" placeholder="username" />'+
          '<div class="label2">PASSWORT</div>'+
          '<input id="xc-pass" readonly class="input focusable" data-kind="xc-input" data-idx="2" placeholder="password" />'+
          '<div class="label2">URL</div>'+
          '<input id="xc-url" readonly class="input focusable" data-kind="xc-input" data-idx="3" placeholder="http://server:port" />'+
          '<div class="btnrow">'+
            '<div id="xc-save" class="btn focusable" data-kind="xc-save" data-idx="4">'+(xcEditIdx>-1?'Aktualisieren':'Speichern')+'</div>'+
            '<div id="xc-cancel" class="btn danger focusable" data-kind="xc-cancel" data-idx="5">Abbrechen</div>'+
          '</div>'+
          '<div class="card2-sub" style="font-size:18px;margin-top:12px;">OK auf Feld = Tastatur • OK auf Button = Aktion</div>'+
        '</div>'+
      '</div>';

    html += '</div>';
    host.innerHTML = html;

    if(xcEditIdx>-1 && xcProfiles[xcEditIdx]){
      $("xc-name").value = xcProfiles[xcEditIdx].name || "";
      $("xc-user").value = xcProfiles[xcEditIdx].user || "";
      $("xc-pass").value = xcProfiles[xcEditIdx].pass || "";
      $("xc-url").value  = xcProfiles[xcEditIdx].url  || "";
    }else{
      $("xc-name").value="";
      $("xc-user").value="";
      $("xc-pass").value="";
      $("xc-url").value="";
    }
  }

  // -----------------------------
  // TV - Load M3U (NO LIMIT + Gesamtcount)
  // -----------------------------
  function tvReloadFromActiveProfile(){
    var p=getActiveM3U();
    tvCats=[]; tvAllChans=[]; tvCurChans=[];
    tvCatIdx=0; tvChanIdx=0;
    tvTotalCount=0;
    $("tv-now").innerText="-";
    if(!p || !p.url){
      $("tv-msg").innerText="Wähle ein M3U Profil in EINSTELLUNG → M3U PROFILE";
      renderTVLists();
      return;
    }
    $("tv-msg").innerText="Lade M3U: "+(p.name||"Profil")+" …";
    loadM3U(p.url);
  }

  function loadM3U(url){
    var xhr=new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.timeout=45000;
    xhr.onreadystatechange=function(){
      if(xhr.readyState!==4) return;
      if(xhr.status===200 && xhr.responseText){
        parseM3U(xhr.responseText);
        tvTotalCount = tvAllChans.length;
        buildTVCategories();
        filterTVCategory(tvCats[0] ? tvCats[0].key : "ALL");
        $("tv-msg").innerText="Sender gesamt: "+tvTotalCount+" • OK=Play • 0=Fav • Back=Menu • OK(2s)=Profil";
      }else{
        $("tv-msg").innerText="M3U Fehler ("+xhr.status+")";
        tvCats=[]; tvAllChans=[]; tvCurChans=[]; tvTotalCount=0;
        renderTVLists();
      }
    };
    xhr.ontimeout=function(){
      $("tv-msg").innerText="M3U Timeout";
      tvCats=[]; tvAllChans=[]; tvCurChans=[]; tvTotalCount=0;
      renderTVLists();
    };
    xhr.send();
  }

  function parseM3U(text){
    var lines=text.split("\n");
    tvAllChans=[];
    var pending=null;
    for(var i=0;i<lines.length;i++){
      var line=(lines[i]||"").trim();
      if(!line) continue;
      if(line.indexOf("#EXTINF")===0){
        var parts=line.split(",");
        var name=(parts.length>1?parts[parts.length-1]:"Unbekannt").trim();
        var g=line.match(/group-title="([^"]*)"/i);
        var group=(g && g[1])?g[1].trim():"Ohne Kategorie";
        pending={name:name,group:group};
        continue;
      }
      if(pending && (line.indexOf("http")===0 || line.indexOf("https")===0)){
        tvAllChans.push({name:pending.name, group:pending.group, url:line});
        pending=null;
      }
    }
  }

  function buildTVCategories(){
    var counts={};
    for(var i=0;i<tvAllChans.length;i++){
      var g=tvAllChans[i].group || "Ohne Kategorie";
      counts[g]=(counts[g]||0)+1;
    }
    var groups=Object.keys(counts).sort(function(a,b){ return a.localeCompare(b); });
    tvCats=[];
    tvCats.push({key:"ALL", label:"ALL ("+tvAllChans.length+")"});
    tvCats.push({key:"Favoriten", label:"Favoriten ("+tvFavs.length+")"});
    for(var j=0;j<groups.length;j++){
      tvCats.push({key:groups[j], label:groups[j]+" ("+counts[groups[j]]+")"});
    }
  }

  function filterTVCategory(key){
    if(key==="ALL") tvCurChans = tvAllChans.slice();
    else if(key==="Favoriten") tvCurChans = tvAllChans.filter(function(c){ return tvFavs.indexOf(c.url)>-1; });
    else tvCurChans = tvAllChans.filter(function(c){ return (c.group||"Ohne Kategorie")===key; });
    tvChanIdx=0;
    renderTVLists();
  }

  function renderTVLists(){
    var ch="";
    for(var i=0;i<tvCats.length;i++){
      ch += '<div class="entry tv-cat" data-idx="'+i+'">'+esc(tvCats[i].label)+'</div>';
    }
    $("tv-cat-list").innerHTML = ch || '<div style="padding:16px;color:rgba(255,255,255,.6);font-weight:900">Keine Kategorien</div>';
    $("tv-cat-count").innerText = tvCats.length ? (tvCats.length+"") : "";

    var hh="";
    for(var j=0;j<tvCurChans.length;j++){
      var c=tvCurChans[j];
      var isFav = (tvFavs.indexOf(c.url)>-1);
      hh += '<div class="entry tv-chan'+(isFav?' is-fav':'')+'" data-idx="'+j+'">'+
              '<span class="chan-num">'+(j+1)+'</span>'+
              '<span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+esc(c.name)+'</span>'+
              '<span class="star">★</span>'+
            '</div>';
    }
    $("tv-chan-list").innerHTML = hh || '<div style="padding:16px;color:rgba(255,255,255,.6);font-weight:900">Keine Sender</div>';
    $("tv-chan-count").innerText = tvCurChans.length ? (tvCurChans.length+"") : "";

    updateFocus();
  }

  function tvPlayCurrent(){
    if(!tvCurChans || !tvCurChans.length || !tvCurChans[tvChanIdx]) return;
    var ch = tvCurChans[tvChanIdx];
    $("tv-now").innerText = ch.name || "Kanal";
    $("tv-msg").innerText = "Sender gesamt: "+tvTotalCount+" • OK=Play • 0=Fav • Back=Menu • OK(2x)=Fullscreen • OK(2s)=Profil";
    playUrl(ch.url);
  }

  function tvToggleFav(){
    if(!tvCurChans[tvChanIdx]) return;
    var url = tvCurChans[tvChanIdx].url;
    var ix = tvFavs.indexOf(url);
    if(ix>-1) tvFavs.splice(ix,1); else tvFavs.push(url);
    localStorage.setItem("iptv_tv_favs", JSON.stringify(tvFavs));
    buildTVCategories();
    var catKey = tvCats[tvCatIdx] ? tvCats[tvCatIdx].key : "ALL";
    filterTVCategory(catKey);
  }

  // -----------------------------
  // TV Profile Dropup (FIX: funktioniert auch ohne keyup)
  // -----------------------------
  var tvProfOpen=false;
  var tvProfIdx=0;

  function tvProfRender(){
    var host=$("tv-prof-list");
    var html="";
    if(!m3uProfiles.length){
      html = '<div style="padding:18px;color:rgba(255,255,255,.75);font-weight:900;font-size:24px">Keine M3U Profile gespeichert.</div>';
      host.innerHTML=html;
      return;
    }
    for(var i=0;i<m3uProfiles.length;i++){
      var p=m3uProfiles[i];
      var isActive = (p.id && p.id===activeM3UId);
      html += '<div class="tvprof-item'+(i===tvProfIdx?' focused':'')+'" data-idx="'+i+'">'+
                esc(p.name||("Profil "+(i+1)))+
                (isActive?'<span class="tvprof-sub">AKTIV</span>':'')+
              '</div>';
    }
    host.innerHTML=html;
  }

  function tvProfOpenOverlay(){
    tvProfOpen=true;
    area="tvProf";
    tvProfIdx=0;
    $("tv-prof-overlay").classList.add("active");
    tvProfRender();
  }
  function tvProfCloseOverlay(){
    $("tv-prof-overlay").classList.remove("active");
    tvProfOpen=false;
    // zurück dahin wo du warst
    area = (showingTV() ? "tvChans" : "menu");
    updateFocus();
  }
  function tvProfMove(dir){
    if(!m3uProfiles.length) return;
    tvProfIdx = clamp(tvProfIdx + dir, 0, m3uProfiles.length-1);
    tvProfRender();
    try{
      var el=$("tv-prof-list").querySelector('.tvprof-item[data-idx="'+tvProfIdx+'"]');
      if(el) el.scrollIntoView({block:"center"});
    }catch(e){}
  }
  function tvProfActivate(){
    if(!m3uProfiles[tvProfIdx]) return;
    setActiveM3U(m3uProfiles[tvProfIdx].id);
    tvProfCloseOverlay();
    tvReloadFromActiveProfile();
  }

  // Long-press engine (Enter) – safe on Samsung (keyup kann fehlen)
  var okTrack=false;
  var okRepeated=false;
  var okLongOpened=false;
  var okShortTimer=null;
  var okLongTimer=null;

  function cancelOkTimers(){
    okTrack=false;
    okRepeated=false;
    okLongOpened=false;
    if(okShortTimer) clearTimeout(okShortTimer);
    if(okLongTimer) clearTimeout(okLongTimer);
    okShortTimer=null;
    okLongTimer=null;
  }

  function handleEnterPressForTV(shortAction){
    // already tracking
    if(!okTrack){
      okTrack=true;
      okRepeated=false;
      okLongOpened=false;

      // SHORT: wenn nach 350ms keine repeats kamen -> short action (TV-sicher)
      okShortTimer=setTimeout(function(){
        if(okTrack && !okRepeated && !okLongOpened){
          cancelOkTimers();
          shortAction();
        }
      }, 350);

      // LONG: nach 2000ms -> dropup
      okLongTimer=setTimeout(function(){
        if(okTrack){
          okLongOpened=true;
          cancelOkTimers();
          tvProfOpenOverlay();
        }
      }, 2000);
    }
  }

  function showingTV(){
    return $("tv-view").style.display==="block";
  }

  // -----------------------------
  // Keyboard (wie vorher)
  // -----------------------------
  var vkOpen=false;
  var vkPrevArea="setupContent";
  var vkPrevFocusIdx=0;
  var vkTargetInputId="";
  var vkText="";
  var vkCaps=false;
  var vkMode="abc";
  var vkRow=0, vkCol=0;
  var vkGrid=[];

  function vkLayouts(){
    var abc = [
      ["q","w","e","r","t","z","u","i","o","p"],
      ["a","s","d","f","g","h","j","k","l","ü"],
      [{t:"⇧",a:"caps",w:"wide",cls:"primary"},"y","x","c","v","b","n","m","ö",{t:"⌫",a:"backspace",w:"wide",cls:"danger"}],
      [{t:"123",a:"mode_num",w:"xxwide",cls:"primary"},{t:",",a:"char",ch:",",w:"wide"},{t:"SPACE",a:"space",w:"xwide",cls:"primary"},{t:".",a:"char",ch:".",w:"wide"},{t:"DONE",a:"done",w:"xxwide",cls:"primary"}]
    ];
    var num = [
      ["1","2","3","4","5","6","7","8","9","0"],
      ["-","/",":",";","(",")","€","&","@","\""],
      [{t:"ABC",a:"mode_abc",w:"xxwide",cls:"primary"},{t:".com",a:"text",ch:".com",w:"wide",cls:"primary"},{t:"SPACE",a:"space",w:"xwide",cls:"primary"},{t:"?",a:"char",ch:"?",w:"wide"},{t:"⌫",a:"backspace",w:"xxwide",cls:"danger"}],
      [{t:"# + =",a:"mode_sym",w:"xxwide",cls:"primary"},{t:",",a:"char",ch:",",w:"wide"},{t:"ä",a:"char",ch:"ä",w:"wide"},{t:"ß",a:"char",ch:"ß",w:"wide"},{t:"DONE",a:"done",w:"xxwide",cls:"primary"}]
    ];
    var sym = [
      ["[","]","{","}","#","%","^","*","+","="],
      ["_","\\","|","~","<",">","$","£","¥","•"],
      [{t:"ABC",a:"mode_abc",w:"xxwide",cls:"primary"},{t:"@",a:"char",ch:"@",w:"wide"},{t:"SPACE",a:"space",w:"xwide",cls:"primary"},{t:"!",a:"char",ch:"!",w:"wide"},{t:"⌫",a:"backspace",w:"xxwide",cls:"danger"}],
      [{t:"123",a:"mode_num",w:"xxwide",cls:"primary"},{t:".",a:"char",ch:".",w:"wide"},{t:"-",a:"char",ch:"-",w:"wide"},{t:"/",a:"char",ch:"/",w:"wide"},{t:"DONE",a:"done",w:"xxwide",cls:"primary"}]
    ];
    return {abc:abc, num:num, sym:sym};
  }

  function vkBuildGrid(){
    var lay = vkLayouts()[vkMode];
    vkGrid = [];
    for(var r=0;r<lay.length;r++){
      var row = lay[r];
      var out=[];
      for(var c=0;c<row.length;c++){
        var k=row[c];
        if(typeof k==="string"){
          out.push({t:k,a:"char",ch:k,w:"",cls:""});
        }else{
          out.push({t:k.t,a:k.a,ch:(k.ch||k.t),w:(k.w||""),cls:(k.cls||"")});
        }
      }
      vkGrid.push(out);
    }
    vkRow=clamp(vkRow,0,vkGrid.length-1);
    vkCol=clamp(vkCol,0,vkGrid[vkRow].length-1);
  }

  function vkRender(){
    vkBuildGrid();
    var host=$("vk-rows");
    var html="";
    for(var r=0;r<vkGrid.length;r++){
      html+='<div class="vk-row" data-r="'+r+'">';
      for(var c=0;c<vkGrid[r].length;c++){
        var k=vkGrid[r][c];
        var cls="vk-key";
        if(k.w==="wide") cls+=" wide";
        if(k.w==="xwide") cls+=" xwide";
        if(k.w==="xxwide") cls+=" xxwide";
        if(k.cls) cls+=" "+k.cls;
        html+='<div class="'+cls+'" data-r="'+r+'" data-c="'+c+'">'+esc(k.t)+'</div>';
      }
      html+='</div>';
    }
    host.innerHTML=html;
    vkUpdateFocus();
    vkUpdatePreview();
  }

  function vkUpdatePreview(){
    $("vk-preview").innerText = vkText || "";
    var label = vkTargetInputId ? ("Eingabe: " + vkTargetInputId) : "Eingabe";
    $("vk-targethint").innerText = label + " • Mode: " + (vkMode==="abc"?"ABC":(vkMode==="num"?"123":"SYM")) + (vkCaps?" • CAPS":"");
  }

  function vkUpdateFocus(){
    var keys=$("vk-rows").getElementsByClassName("vk-key");
    for(var i=0;i<keys.length;i++) keys[i].classList.remove("focused");
    var sel='.vk-key[data-r="'+vkRow+'"][data-c="'+vkCol+'"]';
    var el=document.querySelector(sel);
    if(el) el.classList.add("focused");
  }

  function vkOpenFor(inputId){
    var inp=$(inputId);
    if(!inp) return;
    vkPrevArea=area;
    vkPrevFocusIdx=setupFocusIdx;
    vkTargetInputId=inputId;
    vkText=inp.value||"";
    vkCaps=false;
    vkMode="abc";
    vkRow=0; vkCol=0;
    vkOpen=true;
    area="keyboard";
    $("vk-overlay").classList.add("active");
    vkRender();
  }

  function vkClose(apply){
    var inp = vkTargetInputId ? $(vkTargetInputId) : null;
    if(apply && inp) inp.value = vkText;
    $("vk-overlay").classList.remove("active");
    vkOpen=false;
    area=vkPrevArea||"setupContent";
    setupFocusIdx=vkPrevFocusIdx||0;
    vkTargetInputId="";
    updateFocus();
  }

  function vkInsertChar(ch){
    if(ch==null) return;
    var out=ch;
    if(vkMode==="abc" && vkCaps && out.length===1) out=out.toUpperCase();
    vkText += out;
    vkUpdatePreview();
  }
  function vkBackspace(){
    if(!vkText) return;
    vkText = vkText.slice(0, vkText.length-1);
    vkUpdatePreview();
  }
  function vkActivateKey(){
    var row = vkGrid[vkRow] || [];
    var k = row[vkCol];
    if(!k) return;

    if(k.a==="char"){ vkInsertChar(k.ch); return; }
    if(k.a==="text"){ vkInsertChar(k.ch); return; }
    if(k.a==="space"){ vkInsertChar(" "); return; }
    if(k.a==="caps"){ vkCaps=!vkCaps; vkUpdatePreview(); return; }
    if(k.a==="backspace"){ vkBackspace(); return; }
    if(k.a==="done"){ vkClose(true); return; }
    if(k.a==="mode_abc"){ vkMode="abc"; vkRow=0; vkCol=0; vkRender(); return; }
    if(k.a==="mode_num"){ vkMode="num"; vkRow=0; vkCol=0; vkRender(); return; }
    if(k.a==="mode_sym"){ vkMode="sym"; vkRow=0; vkCol=0; vkRender(); return; }
  }
  function vkMove(dr, dc){
    var nr=clamp(vkRow+dr,0,vkGrid.length-1);
    var nc=clamp(vkCol+dc,0,(vkGrid[nr]?vkGrid[nr].length-1:0));
    vkRow=nr; vkCol=nc;
    vkUpdateFocus();
  }

  // -----------------------------
  // Focus painter
  // -----------------------------
  function updateFocus(){
    renderMenuFocus();

    if($("setup-view").style.display==="flex"){
      for(var t=0;t<4;t++){
        $("t"+t).classList.toggle("focused", area==="tabs" && t===tabIdx);
      }
      setSetupTitle();

      var f=getSetupFocusables();
      for(var j=0;j<f.length;j++) f[j].classList.remove("focused");
      if(area==="setupContent" && f.length){
        setupFocusIdx=clamp(setupFocusIdx,0,f.length-1);
        f[setupFocusIdx].classList.add("focused");
        try{ f[setupFocusIdx].scrollIntoView({block:"center"}); }catch(e){}
      }
    }

    if($("tv-view").style.display==="block"){
      var cats=$("tv-cat-list").getElementsByClassName("tv-cat");
      for(var c=0;c<cats.length;c++){
        cats[c].classList.toggle("focused", area==="tvCats" && c===tvCatIdx);
        if(area==="tvCats" && c===tvCatIdx) try{ cats[c].scrollIntoView({block:"center"});}catch(e){}
      }
      var chans=$("tv-chan-list").getElementsByClassName("tv-chan");
      for(var d=0;d<chans.length;d++){
        chans[d].classList.toggle("focused", area==="tvChans" && d===tvChanIdx);
        if(area==="tvChans" && d===tvChanIdx) try{ chans[d].scrollIntoView({block:"center"});}catch(e){}
      }
    }

    if($("vod-view").style.display==="block"){
      // cats focus
      if(area==="vodCats") renderVodCats();
      if(area==="vodGrid") renderVodGrid();
    }

    if($("sport-view").style.display==="block"){
      $("s0").classList.toggle("focused", area==="sportTabs" && sportTabIdx===0);
      $("s1").classList.toggle("focused", area==="sportTabs" && sportTabIdx===1);
    }
  }

  // -----------------------------
  // Sport placeholder
  // -----------------------------
  function renderSport(){
    $("sport-title").innerText = (sportTabIdx===0) ? "SPORT" : "LIVE SCORE";
    var host=$("sport-content");
    if(sportTabIdx===0){
      host.innerHTML =
        '<div class="card2">'+
          '<div class="card2-title">SPORT</div>'+
          '<div class="card2-sub">Platzhalter – hier kannst du später Sport Streams/Kategorien einbauen.</div>'+
        '</div>';
    }else{
      host.innerHTML =
        '<div class="card2">'+
          '<div class="card2-title">LIVE SCORE</div>'+
          '<div class="card2-sub">Platzhalter – hier kannst du später Live Scores anzeigen.</div>'+
        '</div>';
    }
    updateFocus();
  }

  // -----------------------------
  // Key Handling
  // -----------------------------
  document.addEventListener("keydown", function(e){
    var k=e.keyCode;

    // mark repeats (für long-press engine)
    if(k===13 && e.repeat) okRepeated=true;

    // Keyboard overlay
    if(area==="keyboard" && vkOpen){
      if(k===10009 || k===27){ vkClose(false); return; }
      if(k===13){ vkActivateKey(); return; }
      if(k===37){ vkMove(0,-1); return; }
      if(k===39){ vkMove(0, 1); return; }
      if(k===38){ vkMove(-1,0); return; }
      if(k===40){ vkMove( 1,0); return; }
      if(k===48){ vkInsertChar(" "); return; }
      return;
    }

    // TV profile overlay
    if(area==="tvProf" && tvProfOpen){
      if(k===10009 || k===27){ tvProfCloseOverlay(); return; }
      if(k===38){ tvProfMove(-1); return; }
      if(k===40){ tvProfMove( 1); return; }
      if(k===13){ tvProfActivate(); return; }
      return;
    }

    // BACK
    if(k===10009 || k===27){
      cancelOkTimers();
      if(tvFullscreen){ tvToggleFullscreen(); return; }
      if(area==="setupContent"){ area="tabs"; updateFocus(); return; }
      if(area==="tabs"){ area="menu"; updateFocus(); return; }
      if(area==="tvCats" || area==="tvChans"){ area="menu"; updateFocus(); return; }
      if(area==="vodCats" || area==="vodGrid"){ area="menu"; updateFocus(); return; }
      if(area==="sportTabs"){ area="menu"; updateFocus(); return; }
      try{ tizen.application.getCurrentApplication().exit(); }catch(ex){}
      return;
    }

    // Fullscreen TV
    if(tvFullscreen){
      cancelOkTimers();
      if(k===38){ if(tvChanIdx>0) tvChanIdx--; tvPlayCurrent(); return; }
      if(k===40){ if(tvChanIdx<tvCurChans.length-1) tvChanIdx++; tvPlayCurrent(); return; }
      if(k===13){ tvToggleFullscreen(); return; }
      if(k===48){ tvToggleFav(); return; }
      return;
    }

    // MENU (FIX: sofort wählbar + lädt bei highlight direkt)
    if(area==="menu"){
      if(k===37){
        menuIdx = (menuIdx>0)?menuIdx-1:4;
        showMainByMenu(menuIdx);

        // sofort laden/anzeigen
        if(menuIdx===0) tvReloadFromActiveProfile();
        if(menuIdx===1 || menuIdx===2) vodReloadNetflix();
        if(menuIdx===3) { area="menu"; renderSport(); }
        if(menuIdx===4) { renderSetupTabs(); renderSetupTabPreview(); }

        updateFocus();
        return;
      }
      if(k===39){
        menuIdx = (menuIdx<4)?menuIdx+1:0;
        showMainByMenu(menuIdx);

        if(menuIdx===0) tvReloadFromActiveProfile();
        if(menuIdx===1 || menuIdx===2) vodReloadNetflix();
        if(menuIdx===3) { area="menu"; renderSport(); }
        if(menuIdx===4) { renderSetupTabs(); renderSetupTabPreview(); }

        updateFocus();
        return;
      }

      if(k===13 || k===40){
        if(menuIdx===0){ area="tvCats"; updateFocus(); return; }
        if(menuIdx===1 || menuIdx===2){ area="vodCats"; updateFocus(); return; }
        if(menuIdx===3){ area="sportTabs"; renderSport(); updateFocus(); return; }
        if(menuIdx===4){ area="tabs"; updateFocus(); return; }
      }

      updateFocus();
      return;
    }

    // SPORT tabs
    if(area==="sportTabs"){
      if(k===37){ sportTabIdx = (sportTabIdx>0)?sportTabIdx-1:1; renderSport(); return; }
      if(k===39){ sportTabIdx = (sportTabIdx<1)?sportTabIdx+1:0; renderSport(); return; }
      updateFocus(); return;
    }

    // Tabs
    if(area==="tabs"){
      if(k===37){ tabIdx=(tabIdx>0)?tabIdx-1:3; renderSetupTabs(); renderSetupTabPreview(); return; }
      if(k===39){ tabIdx=(tabIdx<3)?tabIdx+1:0; renderSetupTabs(); renderSetupTabPreview(); return; }
      if(k===13 || k===40){ area="setupContent"; setupFocusIdx=0; updateFocus(); return; }
      updateFocus(); return;
    }

    // Setup Content
    if(area==="setupContent"){
      cancelOkTimers();
      var f=getSetupFocusables();
      var len=f.length;

      if(tabIdx===0 && k===48){ setBackground(null); return; }

      if(k===38){
        if(setupFocusIdx===0){ area="tabs"; updateFocus(); return; }
        setupFocusIdx=Math.max(0, setupFocusIdx-1);
        updateFocus(); return;
      }
      if(k===40){
        if(len) setupFocusIdx=Math.min(len-1, setupFocusIdx+1);
        updateFocus(); return;
      }
      if(k===37){
        if(len) setupFocusIdx=Math.max(0, setupFocusIdx-1);
        updateFocus(); return;
      }
      if(k===39){
        if(len) setupFocusIdx=Math.min(len-1, setupFocusIdx+1);
        updateFocus(); return;
      }

      if(k===13 && len){
        var el=f[setupFocusIdx];
        var kind=el.getAttribute("data-kind")||"";
        var idx=parseInt(el.getAttribute("data-idx")||"-1",10);
        var act=el.getAttribute("data-act")||"";

        if(kind==="bg" && bgItems[idx]){ setBackground(bgItems[idx].url); return; }
        if(kind==="mac"){ tryReadMacAsync(); return; }

        if(kind==="m3u-input"){ if(idx===0) vkOpenFor("m3u-name"); if(idx===1) vkOpenFor("m3u-url"); return; }
        if(kind==="xc-input"){ if(idx===0) vkOpenFor("xc-name"); if(idx===1) vkOpenFor("xc-user"); if(idx===2) vkOpenFor("xc-pass"); if(idx===3) vkOpenFor("xc-url"); return; }

        if(kind==="m3u-act"){
          if(act==="activate"){ if(m3uProfiles[idx]){ setActiveM3U(m3uProfiles[idx].id); tvReloadFromActiveProfile(); renderSetupTabPreview(); } return; }
          if(act==="edit"){ m3uEditIdx=idx; renderSetupTabPreview(); area="setupContent"; updateFocus(); return; }
          if(act==="delete"){ deleteM3UProfile(idx); m3uEditIdx=-1; renderSetupTabPreview(); area="setupContent"; updateFocus(); tvReloadFromActiveProfile(); return; }
        }
        if(kind==="m3u-save"){
          var name=$("m3u-name").value||"";
          var url=$("m3u-url").value||"";
          if(m3uEditIdx>-1){
            if(updateM3UProfile(m3uEditIdx,name,url)){ m3uEditIdx=-1; renderSetupTabPreview(); tvReloadFromActiveProfile(); }
          }else{
            if(addM3UProfile(name,url)){ m3uEditIdx=-1; renderSetupTabPreview(); tvReloadFromActiveProfile(); }
          }
          area="setupContent"; updateFocus(); return;
        }
        if(kind==="m3u-cancel"){ m3uEditIdx=-1; renderSetupTabPreview(); area="setupContent"; updateFocus(); return; }

        if(kind==="xc-act"){
          if(act==="activate"){ if(xcProfiles[idx]){ setActiveXC(xcProfiles[idx].id); vodReloadNetflix(); renderSetupTabPreview(); } return; }
          if(act==="edit"){ xcEditIdx=idx; renderSetupTabPreview(); area="setupContent"; updateFocus(); return; }
          if(act==="delete"){ deleteXCProfile(idx); xcEditIdx=-1; renderSetupTabPreview(); area="setupContent"; updateFocus(); vodReloadNetflix(); return; }
        }
        if(kind==="xc-save"){
          var n=$("xc-name").value||"";
          var u=$("xc-user").value||"";
          var p=$("xc-pass").value||"";
          var s=$("xc-url").value||"";
          if(xcEditIdx>-1){
            if(updateXCProfile(xcEditIdx,n,u,p,s)){ xcEditIdx=-1; renderSetupTabPreview(); vodReloadNetflix(); }
          }else{
            if(addXCProfile(n,u,p,s)){ xcEditIdx=-1; renderSetupTabPreview(); vodReloadNetflix(); }
          }
          area="setupContent"; updateFocus(); return;
        }
        if(kind==="xc-cancel"){ xcEditIdx=-1; renderSetupTabPreview(); area="setupContent"; updateFocus(); return; }
      }

      updateFocus(); return;
    }

    // TV nav
    if(area==="tvCats"){
      if(k===13){
        handleEnterPressForTV(function(){
          area="tvChans";
          var key = tvCats[tvCatIdx] ? tvCats[tvCatIdx].key : "ALL";
          filterTVCategory(key);
          updateFocus();
        });
        return;
      }
      if(k===38){ cancelOkTimers(); if(tvCatIdx>0) tvCatIdx--; updateFocus(); return; }
      if(k===40){ cancelOkTimers(); if(tvCatIdx<tvCats.length-1) tvCatIdx++; updateFocus(); return; }
      if(k===39){ cancelOkTimers(); area="tvChans"; var key = tvCats[tvCatIdx] ? tvCats[tvCatIdx].key : "ALL"; filterTVCategory(key); updateFocus(); return; }
      if(k===37){ cancelOkTimers(); area="menu"; updateFocus(); return; }
      updateFocus(); return;
    }
    if(area==="tvChans"){
      if(k===13){
        handleEnterPressForTV(function(){
          // short OK = play / fullscreen toggle
          if($("tv-now").innerText=== (tvCurChans[tvChanIdx] ? tvCurChans[tvChanIdx].name : "")){
            tvToggleFullscreen();
          }else{
            tvPlayCurrent();
          }
        });
        return;
      }
      if(k===37){ cancelOkTimers(); area="tvCats"; updateFocus(); return; }
      if(k===38){ cancelOkTimers(); if(tvChanIdx>0) tvChanIdx--; updateFocus(); tvPlayCurrent(); return; }
      if(k===40){ cancelOkTimers(); if(tvChanIdx<tvCurChans.length-1) tvChanIdx++; updateFocus(); return; }
      if(k===48){ cancelOkTimers(); tvToggleFav(); return; }
      updateFocus(); return;
    }

    // VOD Netflix nav
    if(area==="vodCats"){
      cancelOkTimers();
      if(k===38){ if(vodCatIdx>0) vodCatIdx--; renderVodCats(); return; }
      if(k===40){ if(vodCatIdx<vodCats.length-1) vodCatIdx++; renderVodCats(); return; }
      if(k===39 || k===13){
        area="vodGrid";
        vodItemIdx=0;
        vodLoadItemsForCurrentCat(true);
        updateFocus();
        return;
      }
      if(k===37){ area="menu"; updateFocus(); return; }
      updateFocus(); return;
    }

    if(area==="vodGrid"){
      cancelOkTimers();
      if(!vodItems.length){
        if(k===37){ area="vodCats"; updateFocus(); return; }
        if(k===13){ vodLoadItemsForCurrentCat(true); return; }
        return;
      }

      if(k===37){
        // left: if first col -> go back to cats
        if((vodItemIdx % vodGridCols)===0){
          area="vodCats"; updateFocus(); return;
        }
        vodItemIdx = Math.max(0, vodItemIdx-1);
        renderVodGrid(); return;
      }
      if(k===39){
        if(vodItemIdx<vodItems.length-1) vodItemIdx++;
        renderVodGrid(); return;
      }
      if(k===38){
        var up = vodItemIdx - vodGridCols;
        if(up>=0) vodItemIdx = up;
        renderVodGrid(); return;
      }
      if(k===40){
        var dn = vodItemIdx + vodGridCols;
        if(dn<=vodItems.length-1) vodItemIdx = dn;
        renderVodGrid(); return;
      }
      if(k===13){
        // erstmal nur Info/Debug (kein Player)
        var it = vodItems[vodItemIdx];
        vodSetDebug("OK: "+(it?it.meta:"-"));
        return;
      }
      updateFocus(); return;
    }
  });

  // keyup -> stop timers (falls tv es sendet)
  document.addEventListener("keyup", function(e){
    if(e.keyCode===13){
      // Wenn keyup kommt, dann war es evtl. short press -> wenn repeat kam, short schon gecancelt
      // Wir lassen timer laufen: shortTimer kümmert sich um short.
      // Aber wir stoppen tracking hier trotzdem nicht, sonst würde long nicht mehr öffnen.
      // (Samsung: keyup ist unzuverlässig) => NICHT canceln.
    }
  });

  // -----------------------------
  // Init
  // -----------------------------
  function init(){
    try{
      ["Up","Down","Left","Right","Enter","Back","0"].forEach(function(k){
        tizen.tvinputdevice.registerKey(k);
      });
    }catch(e){}

    normalizeProfiles();
    initPlayer();
    setTimeout(function(){ applyPlayerRect(false); }, 50);

    tickClock();
    setInterval(tickClock, 1000);

    menuIdx=0;
    area="menu";
    showMainByMenu(menuIdx);

    renderMenuFocus();
    renderSetupTabs();
    renderSetupTabPreview();
    renderSport();

    loadBackgroundsFromGitHub();

    // initial loads
    tvReloadFromActiveProfile();
    vodReloadNetflix();

    updateFocus();
  }
</script>
</body>
</html>
