<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Black IPTV 2026 – Samsung Tizen Ultra</title>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script type="text/javascript" src="$WEBAPIS/webapis/webapis.js"></script>

  <style>
    :root{
      --blue:#0045ff;
      --cyan:#00d2ff;
      --glass:rgba(0,40,120,.22);
      --glass2:rgba(0,0,0,.26);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.40);
      --danger:#ff4d4d;
      --gold:#ffcc00;
      --success:#00ff88;
    }
    *{box-sizing:border-box; outline:none}
    body{
      width:1920px;height:1080px;margin:0;
      background: radial-gradient(circle at top right, #001a4d, #00050a);
      background-size:cover;background-position:center;
      color:#fff;font-family: Arial, sans-serif; overflow:hidden;
    }

    header{
      height:160px;
      display:flex; justify-content:space-between; align-items:center;
      padding:0 80px;
      border-bottom:2px solid rgba(0,210,255,.15);
    }
    .brand{font-size:52px; font-weight:900; letter-spacing:-1px}
    .brand span{color:var(--cyan); font-style:italic}
    #menu{display:flex; gap:18px}
    .menu-item{
      padding:18px 46px;
      font-size:34px;
      font-weight:900;
      color:rgba(255,255,255,.35);
      border-radius:16px;
      transition:.12s;
    }
    .menu-item.focused{
      background:var(--blue);
      color:#fff;
      box-shadow:0 0 30px rgba(0,69,255,.6);
      transform:scale(1.04);
    }

    main{height:920px; padding:40px 60px}

    .panel{
      height:100%;
      border-radius:32px;
      background: var(--glass);
      border:1px solid rgba(0,210,255,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    #tv-view, #vod-view, #setup-view { height:100%; display:none; }

    /* TV VIEW */
    .tv-root{ height:100%; display:flex; gap:24px; padding:22px; }
    .col{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(0,210,255,.14);
      border-radius:26px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .col-h{
      padding:18px 20px;
      color:var(--cyan);
      font-weight:900;
      letter-spacing:3px;
      font-size:14px;
      text-transform:uppercase;
      border-bottom:1px solid rgba(0,210,255,.10);
      display:flex; align-items:center; justify-content:space-between;
    }
    .list{ flex:1; overflow-y:auto; padding:14px; }
    .list::-webkit-scrollbar{ width:0; }
    .entry{
      border-radius:16px;
      border:1px solid rgba(0,210,255,.12);
      background: rgba(0,0,0,.24);
      padding:16px 16px;
      margin-bottom:12px;
      transition:.12s;
      color:rgba(255,255,255,.82);
      font-weight:900;
      font-size:26px;
      display:flex; align-items:center; gap:12px;
    }
    .entry.focused{
      border-color: rgba(0,210,255,.85);
      box-shadow:0 0 18px rgba(0,210,255,.12);
      transform: scale(1.02);
      background: rgba(0,69,255,.18);
      color:#fff;
    }
    .chan-num{ color:var(--cyan); font-weight:900; font-size:18px; min-width:42px; }
    .star{ margin-left:auto; font-size:26px; color:transparent; -webkit-text-stroke:2px var(--gold); }
    .is-fav .star{ color:var(--gold); -webkit-text-stroke:0px transparent; }

    .player{ flex:1.2; display:flex; flex-direction:column; gap:14px; padding:14px; }
    .video-box{
      background:#000;
      border:2px solid rgba(0,210,255,.22);
      border-radius:26px;
      overflow:hidden;
      aspect-ratio:16/9;
      max-height:520px;
      position:relative;
    }
    video{width:100%;height:100%;object-fit:contain}
    .pinfo{ padding:14px; display:flex; flex-direction:column; gap:8px; }
    .pname{ font-size:44px; font-weight:900; }
    #tv-msg{ color:var(--cyan); font-size:18px; font-weight:800; }

    body.is-fullscreen header, body.is-fullscreen main { display:none!important; }
    body.is-fullscreen .video-box{
      position:fixed; left:0; top:0; width:1920px; height:1080px;
      z-index:9999; border:none; border-radius:0;
    }

    /* VOD & SETUP (gekürzt für Übersicht, bleibt wie im Original) */
    .vod-root{ height:100%; display:flex; flex-direction:column; gap:14px; padding:18px 22px; }
    .vod-rows{ flex:1; overflow-y:auto; }
    .card{ width:260px; height:150px; border-radius:16px; overflow:hidden; position:relative; flex:0 0 auto; border:1px solid rgba(0,210,255,.12); }
    .card.focused{ border-color: var(--cyan); transform: scale(1.1); z-index:10; }
    .strip-inner{ display:flex; gap:14px; transition: transform .15s ease-out; }
    
    #setup-view{ display:flex; flex-direction:column; gap:22px; padding:22px; }
    .tabs{ display:flex; gap:14px; padding:10px; background: rgba(0,0,0,.25); border-radius:22px; }
    .tab{ padding:14px 24px; font-size:22px; font-weight:900; color:rgba(255,255,255,.45); border-radius:16px; }
    .tab.focused{ background: var(--blue); color:#fff; }
    .content-body{ flex:1; overflow-y:auto; padding:16px; }
    .input{ width:100%; padding:18px; margin-top:10px; border-radius:14px; background: rgba(0,0,0,.28); color:#fff; border:1px solid var(--cyan); font-size:24px;}
    .btn{ padding:16px; background: var(--blue); text-align:center; border-radius:14px; font-weight:900; margin-top:10px;}
    .tile-wrap{ display:flex; flex-wrap:wrap; gap:14px; }
    .tile{ flex: 0 0 calc((100% - 14px*4) / 5); border-radius:18px; border:1px solid rgba(255,255,255,.1); position:relative; overflow:hidden;}
    .tile.focused{ border-color: var(--cyan); transform:scale(1.05);}
    .tile::before{ content:""; display:block; padding-top:56.25%; }
    .tile img{ position:absolute; top:0; width:100%; height:100%; object-fit:cover; }
  </style>
</head>

<body onload="init()">
  <header>
    <div class="brand">BLACK<span>IPTV</span></div>
    <nav id="menu">
      <div id="m0" class="menu-item">TV</div>
      <div id="m1" class="menu-item">FILME</div>
      <div id="m2" class="menu-item">SERIEN</div>
      <div id="m3" class="menu-item">EINSTELLUNG</div>
    </nav>
  </header>

  <main>
    <div class="panel">
      <div id="tv-view">
        <div class="tv-root">
          <div class="col" style="width:420px">
            <div class="col-h"><span>Kategorien</span><span id="tv-cat-count"></span></div>
            <div id="tv-cat-list" class="list"></div>
          </div>
          <div class="col" style="width:620px">
            <div class="col-h"><span>Sender</span><span id="tv-chan-count"></span></div>
            <div id="tv-chan-list" class="list"></div>
          </div>
          <div class="col" style="flex:1">
            <div class="col-h"><span>Player 2026</span><span>OK = Fullscreen</span></div>
            <div class="player">
              <div class="video-box" id="tv-video-box"><video id="tv-video" autoplay></video></div>
              <div class="pinfo">
                <div class="pname" id="tv-now">-</div>
                <div id="tv-msg">Warte auf Stream...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="vod-view">
        <div class="vod-root">
          <div id="vod-rows" class="vod-rows"></div>
          <div style="display:flex; gap:20px; height:300px; margin-top:20px;">
            <div class="video-box" style="flex:1"><video id="vod-video" autoplay></video></div>
            <div id="vod-info" style="width:500px; padding:20px; background:rgba(0,0,0,0.3); border-radius:20px;">
                <h2 id="vod-info-title">-</h2>
                <p id="vod-info-sub">-</p>
            </div>
          </div>
        </div>
      </div>

      <div id="setup-view">
        <div class="tabs">
          <div id="t0" class="tab">HINTERGRUND</div>
          <div id="t1" class="tab">M3U PROFILE</div>
          <div id="t2" class="tab">XTREAM PROFILE</div>
          <div id="t3" class="tab">MAC ADRESSE</div>
        </div>
        <div class="content-body" id="content-body"></div>
      </div>
    </div>
  </main>

<script>
  // Globale Variablen & State
  var area = "menu", menuIdx = 0, tabIdx = 0, setupFocusIdx = 0;
  var tvCats = [], tvAllChans = [], tvCurChans = [], tvCatIdx = 0, tvChanIdx = 0;
  var tvHls = null, vodHls = null, tvFullscreen = false;
  var m3uProfiles = JSON.parse(localStorage.getItem("iptv_m3u_profiles") || "[]");
  var xcProfiles = JSON.parse(localStorage.getItem("iptv_xc_profiles") || "[]");
  var activeM3UId = localStorage.getItem("iptv_active_m3u_id") || "";
  var activeXCId = localStorage.getItem("iptv_active_xc_id") || "";
  var tvFavs = JSON.parse(localStorage.getItem("iptv_tv_favs") || "[]");
  var bgItems = [];
  var vodRows = [], vodRowIdx = 0, vodItemIdx = 0, vodMode = "movies";

  function $(id){ return document.getElementById(id); }

  // --- PLAYER ENGINE 2026 (FIX: Black Screen & Speed) ---
  function stopHls(player) {
    if (player) {
      player.detachMedia();
      player.destroy();
    }
    return null;
  }

  function tvPlayCurrent() {
    if (!tvCurChans[tvChanIdx]) return;
    var chan = tvCurChans[tvChanIdx];
    $("tv-now").innerText = chan.name;
    $("tv-msg").innerText = "Lade Stream...";

    var v = $("tv-video");
    tvHls = stopHls(tvHls); // Alten Player restlos killen
    
    // Video-Element "reinigen"
    v.pause();
    v.src = "";
    v.load();

    if (window.Hls && Hls.isSupported()) {
      tvHls = new Hls({
        enableWorker: true,
        lowLatencyMode: true,
        backBufferLength: 60,
        startLevel: 0,
        initialLiveManifestSize: 1, // Sofort starten
        maxBufferLength: 10,       // Weniger Vorlauf nötig -> schnellerer Start
        manifestLoadingMaxRetry: 5,
        levelLoadingMaxRetry: 5
      });

      tvHls.loadSource(chan.url);
      tvHls.attachMedia(v);

      tvHls.on(Hls.Events.MANIFEST_PARSED, function() {
        $("tv-msg").innerText = "LIVE";
        v.play().catch(function(e){ console.log("Autoplay blockiert"); });
      });

      // AUTOMATISCHER RECONNECT BEI FEHLERN
      tvHls.on(Hls.Events.ERROR, function(event, data) {
        if (data.fatal) {
          $("tv-msg").innerText = "Reconnect...";
          switch(data.type) {
            case Hls.ErrorTypes.NETWORK_ERROR: tvHls.startLoad(); break;
            case Hls.ErrorTypes.MEDIA_ERROR: tvHls.recoverMediaError(); break;
            default: tvPlayCurrent(); break; // Hard Reset
          }
        }
      });
    } else {
      v.src = chan.url;
      v.play();
    }
  }

  // --- NAVIGATION & UI ---
  function updateFocus() {
    // Menu
    for(var i=0; i<4; i++) $("m"+i).classList.toggle("focused", area==="menu" && i===menuIdx);
    
    // TV List
    var cats = $("tv-cat-list").children;
    for(var c=0; c<cats.length; c++) cats[c].classList.toggle("focused", area==="tvCats" && c===tvCatIdx);
    
    var chans = $("tv-chan-list").children;
    for(var s=0; s<chans.length; s++) chans[s].classList.toggle("focused", area==="tvChans" && s===tvChanIdx);

    // Setup
    for(var t=0; t<4; t++) $("t"+t).classList.toggle("focused", area==="tabs" && t===tabIdx);
    
    var f = $("content-body").querySelectorAll(".focusable");
    for(var j=0; j<f.length; j++) f[j].classList.toggle("focused", area==="setupContent" && j===setupFocusIdx);

    // Scroll into view
    var focused = document.querySelector(".focused");
    if(focused && area !== "menu") focused.scrollIntoView({block:"center", behavior:"smooth"});
  }

  function showMain(view) {
    $("tv-view").style.display = (view==="tv") ? "block" : "none";
    $("vod-view").style.display = (view==="vod") ? "block" : "none";
    $("setup-view").style.display = (view==="setup") ? "flex" : "none";
  }

  // --- M3U LOGIC ---
  function loadM3U(url) {
    fetch(url).then(r => r.text()).then(text => {
      parseM3U(text);
      buildTVCategories();
      filterTVCategory("ALL");
    }).catch(() => { $("tv-msg").innerText = "M3U Fehler"; });
  }

  function parseM3U(text) {
    var lines = text.split("\n");
    tvAllChans = [];
    var pending = null;
    for (var line of lines) {
      line = line.trim();
      if (line.startsWith("#EXTINF")) {
        var name = line.split(",").pop();
        var group = line.match(/group-title="([^"]*)"/i);
        pending = { name: name, group: group ? group[1] : "Allgemein" };
      } else if (pending && line.startsWith("http")) {
        tvAllChans.push({ ...pending, url: line });
        pending = null;
        if (tvAllChans.length > 5000) break;
      }
    }
  }

  function buildTVCategories() {
    var groups = [...new Set(tvAllChans.map(c => c.group))].sort();
    tvCats = [{key:"ALL", label: "ALLE ("+tvAllChans.length+")"}, ...groups.map(g => ({key:g, label:g}))];
    renderTVCats();
  }

  function renderTVCats() {
    $("tv-cat-list").innerHTML = tvCats.map((c, i) => `<div class="entry">${c.label}</div>`).join("");
  }

  function filterTVCategory(key) {
    tvCurChans = (key === "ALL") ? tvAllChans : tvAllChans.filter(c => c.group === key);
    tvChanIdx = 0;
    $("tv-chan-list").innerHTML = tvCurChans.map((c, i) => `
      <div class="entry">
        <span class="chan-num">${i+1}</span>
        <span style="flex:1; overflow:hidden;">${c.name}</span>
      </div>`).join("");
    updateFocus();
  }

  // --- KEY HANDLING ---
  document.addEventListener("keydown", function(e) {
    var k = e.keyCode;
    // Back / Return
    if (k === 10009 || k === 27) {
      if(tvFullscreen) { tvFullscreen=false; document.body.classList.remove("is-fullscreen"); return; }
      if(area === "tvChans") { area="tvCats"; updateFocus(); return; }
      if(area === "tvCats" || area === "tabs") { area="menu"; updateFocus(); return; }
      if(area === "setupContent") { area="tabs"; updateFocus(); return; }
      tizen.application.getCurrentApplication().exit();
    }

    if (area === "menu") {
      if(k===37) { menuIdx=(menuIdx>0)?menuIdx-1:3; showMainByMenu(menuIdx); }
      if(k===39) { menuIdx=(menuIdx<3)?menuIdx+1:0; showMainByMenu(menuIdx); }
      if(k===13 || k===40) { 
          if(menuIdx===0) area="tvCats"; 
          else if(menuIdx===3) area="tabs";
          else area="vod";
      }
    } 
    else if (area === "tvCats") {
      if(k===38 && tvCatIdx>0) tvCatIdx--;
      if(k===40 && tvCatIdx<tvCats.length-1) tvCatIdx++;
      if(k===13 || k===39) { filterTVCategory(tvCats[tvCatIdx].key); area="tvChans"; }
    }
    else if (area === "tvChans") {
      if(k===38 && tvChanIdx>0) { tvChanIdx--; tvPlayCurrent(); }
      if(k===40 && tvChanIdx<tvCurChans.length-1) { tvChanIdx++; tvPlayCurrent(); }
      if(k===13) { tvFullscreen=true; document.body.classList.add("is-fullscreen"); }
    }
    else if (area === "tabs") {
        if(k===37) { tabIdx=(tabIdx>0)?tabIdx-1:3; renderSetupContent(); }
        if(k===39) { tabIdx=(tabIdx<3)?tabIdx+1:0; renderSetupContent(); }
        if(k===13 || k===40) { area="setupContent"; setupFocusIdx=0; }
    }

    updateFocus();
  });

  function showMainByMenu(idx) {
    if(idx===0) { showMain("tv"); var p=m3uProfiles[0]; if(p) loadM3U(p.url); }
    if(idx===1 || idx===2) { showMain("vod"); }
    if(idx===3) { showMain("setup"); renderSetupContent(); }
  }

  function renderSetupContent() {
      var body = $("content-body");
      if(tabIdx === 1) {
          body.innerHTML = `
            <input id="m3u-n" class="input focusable" placeholder="Name">
            <input id="m3u-u" class="input focusable" placeholder="URL">
            <div class="btn focusable" onclick="saveM3U()">Speichern</div>
          `;
      } else if(tabIdx === 3) {
          body.innerHTML = `<h1 class="focusable">MAC: ${webapis.network.getMac()}</h1>`;
      } else {
          body.innerHTML = `<p class="focusable">In Kürze verfügbar...</p>`;
      }
      updateFocus();
  }

  function init() {
    try {
      ["Up","Down","Left","Right","Enter","Back","0"].forEach(k => tizen.tvinputdevice.registerKey(k));
    } catch(e) {}
    showMainByMenu(0);
    updateFocus();
  }
</script>
</body>
</html>
